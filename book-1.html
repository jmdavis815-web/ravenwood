<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <title>Wards of the Manor ¬∑ Ravenwood Interactive Book</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Main Ravenwood styles -->
  <link rel="stylesheet" href="style.css" />
  
  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    crossorigin="anonymous"
  />
  <style>
    /* --- Book layout helpers (minimal extra CSS) --- */

    body.rw-bg {
      background: radial-gradient(circle at top, #111827 0, #020617 60%);
      min-height: 100vh;
    }

    .rw-book-shell {
      max-width: 900px;
      margin: 0 auto;
    }

    .rw-book-body {
      max-height: none;
    }

    .rw-book-image-wrapper {
      margin-bottom: 1.75rem;
    }

    .rw-book-image-frame {
      position: relative;
      border-radius: 1rem;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: radial-gradient(circle at top, #0f172a 0, #020617 55%);
      min-height: 220px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .rw-book-image-frame img {
      width: 100%;
      height: auto;
      object-fit: cover;
      display: block;
    }

    /* Glow overlay where you want the talisman dropped */
    .rw-book-drop-hotspot {
      position: absolute;
      inset: 25% 30%;
      border: 2px dashed rgba(250, 204, 21, 0.8);
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle, rgba(250, 204, 21, 0.12), transparent);
      box-shadow: 0 0 28px rgba(250, 204, 21, 0.65);
      pointer-events: auto;
    }

    .rw-book-drop-label {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #fefce8;
      text-shadow: 0 1px 3px rgba(15, 23, 42, 0.9);
    }

    .rw-book-drop-hotspot.rw-drop-success {
      border-style: solid;
      box-shadow: 0 0 32px rgba(34, 197, 94, 0.9);
    }

    .rw-book-drop-hotspot.rw-drop-fail {
      border-color: rgba(239, 68, 68, 0.9);
      box-shadow: 0 0 32px rgba(239, 68, 68, 0.9);
    }

    .rw-book-choices button {
      text-align: left;
      white-space: normal;
    }

    .rw-book-choices button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .rw-book-page-meta {
      font-size: 0.8rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    /* Inventory panel specific to the book view */

    #rwBookInventoryPanel {
      max-width: 480px;
      margin: 0 auto 1.5rem;
      padding: 0.75rem 0.75rem 0.25rem;
      border-radius: 0.9rem;
      background: radial-gradient(circle at top left, #020617 0, #020617 45%, #030712 100%);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    #rwBookInventoryGrid {
      margin-top: 0.5rem;
    }

    .rw-book-system-msg {
      min-height: 1.2rem;
    }

    @media (max-width: 768px) {
      .rw-book-image-frame {
        min-height: 180px;
      }
      #rwBookInventoryPanel {
        width: 100%;
      }
    }
  </style>
</head>
<body class="rw-bg" data-page="book">
  <!-- Simple nav back to Ravenwood -->
  <nav class="navbar navbar-expand-lg rw-navbar border-bottom">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="ravenwood.html">
        Ravenwood
      </a>
      <span class="navbar-text small text-muted ms-3">
        Wards of the Manor ¬∑ Book I
      </span>
      <a href="ravenwood.html" class="btn btn-sm rw-btn-main ms-auto">
        ‚üµ Town &amp; Manor
      </a>
    </div>
  </nav>

  <main class="py-4 py-md-5">
    <div class="container rw-book-shell">
      <div class="rw-card p-4 p-md-5 shadow-lg">
        <header class="mb-4 text-center">
          <p class="rw-tagline text-uppercase mb-1">Interactive Ravenwood Story</p>
          <h1 class="rw-title mb-2">Wards of the Manor</h1>
          <p class="rw-body mb-0">
            Book I ¬∑ Your choices shape how the Manor remembers you. Read slowly, follow the paths that call to you, and
            let the talisman guide your way.
          </p>
        </header>

        <hr class="my-4" />

        <!-- Inventory toggle + panel -->
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="rw-book-page-meta" id="rwBookPageMeta">Page 1</span>
          <button id="rwBookInventoryToggle" class="btn btn-outline-light btn-sm">
            üëú Open Inventory
          </button>
        </div>

        <div id="rwBookInventoryPanel" class="d-none">
          <div class="d-flex justify-content-between align-items-center">
            <span class="small text-muted">
              Tap an item in your pack to open options. Choose <strong>Use</strong> or <strong>Description</strong>.
            </span>
            <button class="btn btn-link btn-sm text-decoration-none text-muted" id="rwBookInventoryClose">
              Close ‚úï
            </button>
          </div>
          <div id="rwBookInventoryGrid" class="rw-inventory-grid mt-2"></div>
        </div>

        <!-- Page content -->
        <article id="rwBookPageContainer" class="rw-book-body">
          <!-- Image slot -->
          <div class="rw-book-image-wrapper">
            <div class="rw-book-image-frame">
              <!-- Replace src per page; you can drop real art for each scene -->
              <img
                id="rwBookImage"
                src="book-page-1.png"
                alt="Ravenwood Manor scene"
                onerror="this.style.display='none';"
              />
              <!-- Drag-drop hotspot (currently unused but kept) -->
              <div id="rwBookDropHotspot" class="rw-book-drop-hotspot d-none">
                <span class="rw-book-drop-label">Drop the talisman here</span>
              </div>
            </div>
          </div>

          <h2 id="rwBookPageTitle" class="rw-title fs-4 mb-3"></h2>
          <div id="rwBookPageBody" class="rw-body mb-4"></div>

          <div id="rwBookSystemMessage" class="rw-book-system-msg small text-warning mb-2 d-none"></div>

          <div id="rwBookChoices" class="rw-book-choices d-flex flex-column gap-2 mb-3"></div>
        </article>
      </div>
    </div>
  </main>

  <!-- Bootstrap JS -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    crossorigin="anonymous"
  ></script>

  <!-- Supabase JS (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Your global Ravenwood logic (Supabase, inventory helpers, etc.) -->
  <script src="app.js"></script>

  <!-- Book engine -->
  <script>
    (function () {
      const TALISMAN_ITEM_ID = "old_talisman";

      // Simple state for this book session
      const BOOK_STATE = {
        currentPageId: "1",
        talismanUsedPages: {}, // { "5": true } etc.
        inventory: [],
        flags: {},            // remembers important past choices
        lastChoiceKey: null,  // remembers the *immediately* previous choice
      };

      // Supabase / character info for this book session
      let currentBookEmail = null;
      let currentBookChar = null;

      // Save book progress (Supabase)
      async function saveBookProgress(pageId, options = {}) {
        if (!currentBookEmail) return;

        try {
          const update = {
            book1_started: true,
            book1_last_page: pageId,
          };

          if (options.completed === true) {
            update.book1_completed = true;
          }

          const { error } = await supabaseClient
            .from("data")
            .update(update)
            .eq("email", currentBookEmail);

          if (error) {
            console.error("Failed to save book progress:", error);
          } else if (currentBookChar) {
            currentBookChar.book1_started = true;
            currentBookChar.book1_last_page = pageId;
          }
        } catch (err) {
          console.error("Unexpected error saving book progress:", err);
        }
      }

      // --- PAGE DATA ---
      const BOOK_PAGES = {
        "1": {
          title: "The Manor That Waits",
          image: "b1-p1.png",
          body: `
      <p>
        Fog curls around your boots as you step onto the ancient path. Lanterns along the drive gutter, then flare
        brighter, as if recognizing the metal resting in your pocket.
      </p>
      <p>
        The Manor looms ahead: windows burning with a few patient lights, stone black with old rain. The air hums
        faintly. Not storm, not wind. <em>Attention.</em>
      </p>
      <p>
        When your foot crosses the final stone at the threshold, the great door opens on its own‚Äînot with a creak,
        but with a long, low <em>sigh</em>, as though the house is finally waking.
      </p>
      <p>
        A woman with silver hair waits just inside the hall, eyes sharp, expression somewhere between relief
        and apology. Lines of ward-light trace faintly along the stones behind her, like veins beneath skin.
      </p>
      <p class="rw-intro-dialog">
        ‚ÄúYou brought it back,‚Äù she says softly. ‚ÄúThe talisman.‚Äù
      </p>
    `,
          choices: [
            { text: "Step inside cautiously.", to: "2", key: "p1_cautious" },
            { text: "Enter as if you belong here.", to: "2", key: "p1_belong" },
            {
              text: "Ask who she is before crossing the threshold.",
              to: "2",
              key: "p1_ask_who",
            },
          ],
        },

        "2": {
          title: "Mira Ashbourne",
          image: "b1-p2.png",
          body: `
      <p>
        You step into the entry hall. Warm golden light spills from lanterns clustered along carved stone pillars,
        flickering like breath. The floor beneath you is marked with a circle of old sigils, worn by time but still
        faintly luminous.
      </p>
      <p>
        The silver-haired woman studies you‚Äînot suspicious, but searching, as if listening to something just
        behind your heartbeat.
      </p>
      <p class="rw-intro-dialog">
        ‚ÄúMira Ashbourne,‚Äù she says. ‚ÄúKeeper of the Manor. Ward-tender. And until tonight‚Ä¶‚Äù Her mouth twists into a
        wry almost-smile. ‚Äú‚Ä¶the only one left listening when it cries.‚Äù
      </p>
      <p>
        The talisman at your chest hums‚Äîa low, steady vibration‚Äîanswering the glow in the floor. Lines of light
        stir between stone and metal, spider-fine threads reaching for one another.
      </p>
      <p>
        You start to ask what it means to be an <strong>anchor</strong>, and Mira lifts a hand.
      </p>
      <p class="rw-intro-dialog">
        ‚ÄúAnchors keep houses like this from drifting off their own stories,‚Äù she says. ‚ÄúYou ground the wards,
        the way a lightning rod grounds a storm. But explanations can wait. The Manor wants to meet you first,
        and it grows‚Ä¶impatient.‚Äù
      </p>
    `,
          choices: [
            {
              text: "‚ÄúWhat does it mean to be an anchor?‚Äù",
              to: "3",
              key: "p2_ask_anchor",
            },
            {
              text: "‚ÄúWhat‚Äôs wrong with the wards?‚Äù",
              to: "3",
              key: "p2_ask_wards",
            },
            {
              text: "Touch the talisman, testing how it responds.",
              to: "3",
              key: "p2_touch_talisman",
            },
          ],
        },

        "3": {
          title: "The Listening Door",
          image: "book-page-3.png",
          body: `
      <p>
        Mira leads you deeper into the hall. Portraits with blurred faces line the walls; some seem to turn
        slightly as you pass. Above, a chandelier hums like a throat swallowing light.
      </p>
      <p>
        At the far end of the hall stands a tall double door, its surface carved with layered sigils. Bands of
        pale light cinch it shut like glowing iron.
      </p>
      <p class="rw-intro-dialog">
        ‚ÄúThe Manor has layers,‚Äù Mira murmurs. ‚ÄúThis door sits where the living house brushes the level just above
        the Underhall. The older wards gather here to listen.‚Äù
      </p>
      <p>
        As you draw near, your talisman warms. The bands of light along the door vibrate, threads of brilliance
        reaching toward the metal at your throat.
      </p>
      <p class="rw-intro-dialog">
        ‚ÄúIt wants to see you,‚Äù Mira says. ‚ÄúLet it.‚Äù
      </p>
    `,
          choices: [
            { text: "Press your palm to the door.", to: "4", key: "p3_hand" },
            {
              text: "Raise the talisman toward the bands of light.",
              to: "4",
              key: "p3_talisman",
            },
            { text: "Whisper your name to the wood.", to: "4", key: "p3_name" },
          ],
        },

        "4": {
          title: "Contact",
          image: "book-page-4.png",
          body: `
      <p>
        The moment you touch the carved wood, the bands of light flare. A low note thrums through your
        bones. Images tumble across your mind‚Äîfractured pieces of yourself the Manor has no right to know:
        childhood rooms, a familiar voice calling you back, the first time you dreamed of a hill crowned with
        a house you‚Äôd never seen.
      </p>
      <p>
        The talisman sears hot, then cools. Threads of light leap from the door to the metal, then sink inward,
        vanishing beneath your skin.
      </p>
      <p>
        The door hums approval. Something deeper beneath the Manor hums back.
      </p>
      <p class="rw-intro-dialog">
        ‚ÄúThe first gate is open,‚Äù Mira says quietly. ‚ÄúAnd the Underhall knows your name now.‚Äù
      </p>
    `,
          choices: [
            { text: "Step through the door.", to: "5", key: "p4_step" },
            {
              text: "Ask what changed when the gate opened.",
              to: "5",
              key: "p4_ask_change",
            },
            {
              text: "Demand to know what the Underhall is.",
              to: "5",
              key: "p4_demand_underhall",
            },
          ],
        },

        "5": {
          title: "The Wall That Breathes",
          image: "book-page-5.png",
          body: `
      <p>
        Beyond the listening door, the corridor slopes downward in a slow arc. Lanterns burn with a cold,
        silver-blue flame. The air smells of stone, old wax, and something like rain trapped underground.
      </p>
      <p>
        You feel the Manor thin here. Its skin brushes something deeper‚Äîthe Underhall‚Äôs unseen tide.
      </p>
      <p>
        Halfway down the passage, your talisman jolts. Heat flares against your skin, then tugs, insistent,
        pulling your attention toward an unremarkable stretch of wall.
      </p>
      <p>
        To the eye, it is only stone. To the talisman, it <em>breathes</em>.
      </p>
      <p>
        As you watch, faint lines ripple across the surface‚Äîan almost-circle, not yet complete. An old lock
        waiting to remember its key.
      </p>
      <p class="rw-intro-dialog">
        ‚ÄúThat shouldn‚Äôt be waking,‚Äù Mira whispers. ‚ÄúIf you‚Äôre going to use the talisman‚Ä¶ do it carefully.‚Äù
      </p>
      <p class="small text-muted mb-0">
        <em>Open your inventory, select the talisman, and choose <strong>Use</strong> when you‚Äôre ready to test the waking wall.</em>
      </p>
    `,
          requiresTalisman: true,
          dropHint:
            "The hidden lock warms as the talisman nears. Use the talisman while you‚Äôre looking at the wall.",
          dropSuccessText:
            "The stone drinks in the talisman‚Äôs light. A circle completes itself in the wall with a soft chime, and the rock folds inward, revealing a narrow vault beyond.",
          choices: [
            {
              text: "Step into the newly opened vault.",
              to: "6",
              key: "p5_enter_vault",
            },
            {
              text: "Look back at Mira before entering.",
              to: "6",
              key: "p5_look_mira",
            },
          ],
        },

        "6": {
          title: "The Thread-Vault",
          image: "book-page-6.png",
          body: `
      <p>
        The passage beyond the wall is narrow and warm, lit by no visible lanterns‚Äîonly a suspended web of
        silver threads, each one softly luminous. They sway in a breeze you cannot feel.
      </p>
      <p>
        At the center of the chamber stands a pedestal. Resting on it is a single feather made of shifting light,
        its edges dissolving into glowing motes before reforming again.
      </p>
      <p>
        The talisman, still warm against your skin, thrums in time with the feather‚Äôs slow pulse.
      </p>
      <p class="rw-intro-dialog">
        ‚ÄúAn echo-vault,‚Äù Mira breathes. ‚ÄúUntouched since before my grandmother‚Äôs time. The Manor hid this from me.‚Äù
      </p>
      <p>
        Silver threads brush against your shoulders as you move, humming like distant voices. You have the
        unsettling feeling that every step you take in here will matter more than the ones outside.
      </p>
    `,
          choices: [
            {
              text: "Reach toward the feather of light.",
              to: "7",
              key: "take_feather",
            },
            {
              text: "Back away‚Äîthis is too much for one night.",
              to: "8",
              key: "leave_feather",
            },
          ],
        },

        "7": {
          title: "Echo Taken",
          image: "book-page-7.png",
          body: `
      <p>
        Your fingers close around the feather of light. It is not solid, but it is not nothing either‚Äîlike
        gripping the memory of a storm. The moment you touch it, the vault inhales.
      </p>
      <p>
        Threads of silver whip inward, lashing through your chest, your ribs, your bones. For a heartbeat you are
        not in the vault at all: you are standing in the Town Square under a different sky, watching a younger Mira
        argue with a circle of robed figures whose faces blur like the old portraits upstairs.
      </p>
      <p>
        The image shatters. You are back in the vault, gasping. The feather has vanished. The threads settle,
        but some of their light has sunk into your hands, your veins, the talisman at your throat.
      </p>
      <p class="rw-intro-dialog">
        ‚ÄúIt chose you,‚Äù Mira says hoarsely. ‚ÄúThat echo has been sleeping here for generations. Now it rides your
        anchor-line instead of the Manor‚Äôs shelves.‚Äù
      </p>
      <p>
        The vault trembles once, like a held breath finally released. Then the threads dim, gently steering you
        back toward the corridor.
      </p>
    `,
          choices: [
            {
              text: "Let the vault close and follow Mira out.",
              to: "9",
              key: "p7_follow_out",
            },
            {
              text: "Look back once more before you leave.",
              to: "9",
              key: "p7_look_back",
            },
          ],
        },

        "8": {
          title: "Echo Refused",
          image: "book-page-8.png",
          body: `
      <p>
        You stop just short of the pedestal. Instinct claws up your spine‚Äîtoo much, too fast, too soon. Whatever
        the feather holds, it feels like more life than you are ready to remember.
      </p>
      <p>
        You step back. The silver threads around you shiver, then still. The feather flickers, its light dimming
        as if in disappointment, but it does not vanish.
      </p>
      <p class="rw-intro-dialog">
        ‚ÄúGood,‚Äù Mira says quietly. ‚ÄúAnchors are not puppets. The Manor does not get to decide how much of itself
        you carry‚Äînot on the first night.‚Äù
      </p>
      <p>
        She lays two fingers against the talisman. The metal cools, the humming in your bones easing to a tolerable
        thrum. The vault‚Äôs threads loosen, gently guiding you back toward the corridor.
      </p>
      <p>
        As you pass the threshold, the wall seals behind you. The almost-circle mark on the stone glows once in
        farewell, then sinks out of sight.
      </p>
    `,
          choices: [
            {
              text: "Follow Mira back toward the hall.",
              to: "9",
              key: "p8_follow",
            },
            {
              text: "Glance at the sealed wall, uneasy.",
              to: "9",
              key: "p8_uneasy",
            },
          ],
        },

        "9": {
          title: "Ward Feedback",
          image: "book-page-9.png",
          body: `
      <p>
        The corridor seems narrower on the way back. Lantern flames flare as you pass, then lean toward you,
        their light threading briefly between your talisman and the stones.
      </p>
      <p>
        Halfway up the slope, the wards test your footing. The floor tilts‚Äînot physically, but in your nerves‚Äî
        as if the Manor is trying to see whether you will fall inward toward it or pull yourself back to center.
      </p>
      <p>
        Your body remembers the echo-vault, the feather you touched or refused, the choice you made. Your breath
        evens out on instinct. The humming in the walls steadies to match.
      </p>
      <p class="rw-intro-dialog">
        ‚ÄúThere,‚Äù Mira murmurs. ‚ÄúFeel that? That‚Äôs the house adjusting around you. Deciding which way your gravity
        pulls.‚Äù
      </p>
      <p>
        By the time you reach the listening door again, the bands of light have settled. They still cling to the
        wood, but now a faint second ring circles your talisman‚Äîa thread that was not there before.
      </p>
    `,
          choices: [
            {
              text: "Ask Mira what the Manor just decided about you.",
              to: "10",
              key: "p9_ask_decision",
            },
            {
              text: "Stay silent and listen for yourself.",
              to: "10",
              key: "p9_listen_self",
            },
          ],
        },

        "10": {
          title: "The Anchor Explained",
          image: "book-page-10.png",
          body: `
      <p>
        Back in the entry hall, the air feels thinner, easier to breathe. The sigil-circle in the floor glows a
        fraction brighter where your footsteps cross it, recognizing the new thread braided through your name.
      </p>
      <p class="rw-intro-dialog">
        ‚ÄúAnchors are bargains,‚Äù Mira says at last. ‚ÄúYou promise not to look away when the house shows you what it‚Äôs
        keeping out. In return, it promises not to lock you out of yourself when the old stories wake up.‚Äù
      </p>
      <p>
        She gestures toward the staircase that curves upward along the far wall.
      </p>
      <p class="rw-intro-dialog">
        ‚ÄúCome. There‚Äôs one more thing you need to see tonight. After that, the Manor will let you rest‚Äîand send you
        wandering through the town it‚Äôs tied to you.‚Äù
      </p>
      <p>
        As you climb, you feel the pull of other places through the stone: the Moonwell‚Äôs still water, the Old
        Chapel‚Äôs stained glass, the leaning trees at Witchwood‚Äôs edge. Each tug feels like a question the house
        is waiting for you to answer.
      </p>
    `,
          choices: [
            {
              text: "Follow Mira to the upper gallery.",
              to: "11",
              key: "p10_follow",
            },
            {
              text: "Pause on the stairs, testing each tug of the wards.",
              to: "11",
              key: "p10_test_tugs",
            },
          ],
        },

        "11": {
          title: "Balcony Over Ravenwood",
          image: "book-page-11.png",
          body: `
      <p>
        The staircase spills you onto a wide gallery. Tall windows look out over the sleeping town. From here,
        Ravenwood is a scatter of lantern-pricks in the fog‚Äîstreets and roofs and distant trees stitched together
        by silver threads only you and the Manor seem to see.
      </p>
      <p>
        One thread runs bright toward the Town Square fountain, another coils around the dark shape of the Old
        Chapel. A thinner filament shivers at the edge of Witchwood, where the forest watches the houses back.
      </p>
      <p class="rw-intro-dialog">
        ‚ÄúThese are your first bindings,‚Äù Mira says. ‚ÄúPlaces the wards will nudge you toward. They change as you do.
        As you choose.‚Äù
      </p>
      <p>
        The talisman warms in your palm. For an instant, three possible futures flicker at once: you standing in
        Market Lane with charms buzzing in your pockets; you knee-deep in Moonwell water as the sky refuses to show
        a moon; you alone in the Chapel when the stained glass saints all look away at once.
      </p>
      <p class="rw-intro-dialog">
        ‚ÄúBefore the Manor sets its first mark,‚Äù Mira says, ‚Äúyou should decide what kind of anchor you intend to be.‚Äù
      </p>
    `,
          choices: [
            {
              text: "‚ÄúI‚Äôll anchor the people first. The wards can wait.‚Äù",
              to: "12",
              key: "anchor_people",
            },
            {
              text: "‚ÄúI‚Äôll hold the house steady, no matter what it asks me to see.‚Äù",
              to: "12",
              key: "anchor_house",
            },
            {
              text: "‚ÄúI‚Äôll stand between‚Äîno one gets swallowed, not the town, not the Manor.‚Äù",
              to: "12",
              key: "anchor_between",
            },
          ],
        },

        "12": {
          title: "First Mark",
          image: "book-page-12.png",
          body: `
      <p>
        The words leave your mouth, and the Manor listens.
      </p>
      <p>
        Light gathers at the edges of your vision, then narrows into a single thread that drops from the ceiling,
        coils once around your wrist, and sinks into the talisman. It does not burn. It simply <em>settles</em>,
        the way a promise settles when both sides agree to keep it.
      </p>
      <p>
        Somewhere below, a door unlatches itself. Lanterns along the town streets flare, as if the whole of
        Ravenwood is exhaling in relief.
      </p>
      <p class="rw-intro-dialog">
        ‚ÄúThe Manor knows you now,‚Äù Mira says. ‚ÄúAnd the town will start to recognize your footsteps. Go where it
        pulls you. Listen when the wards twitch. Bring back what should not be walking its streets alone.‚Äù
      </p>
      <p>
        She rests a hand briefly on your shoulder, eyes distant as if listening to a dozen whispered reports at once.
      </p>
      <p class="rw-intro-dialog">
        ‚ÄúFor tonight, that is enough. Book I of your binding to the Wards is complete. The rest waits in the
        crooked streets below.‚Äù
      </p>
      <p class="small text-muted mb-0">
        <em>Book I: Wards of the Manor complete. You can return to the Town &amp; Manor page and let your choices
        lead you through Ravenwood.</em>
      </p>
    `,
          choices: [
            {
              text: "Let the Manor dim and return to Ravenwood.",
              to: "1",
              key: "p12_return",
            },
          ],
        },
      };

      // --- INVENTORY LOADING (from game if possible, else fallback) ---
      function loadBookInventory() {
        // 1) If world page seeded inventory from Supabase, use that
        if (Array.isArray(window.rwInitialInventory) && window.rwInitialInventory.length) {
          return [...window.rwInitialInventory];
        }

        // 2) Try localStorage fallback
        try {
          const raw = localStorage.getItem("ravenwoodInventory");
          if (raw) {
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed) && parsed.length) {
              return parsed;
            }
          }
        } catch (e) {
          console.warn("Could not load book inventory from localStorage:", e);
        }

        // 3) Last resort: grant a basic talisman so the puzzle works
        return [
          {
            id: TALISMAN_ITEM_ID,
            name: "Old Talisman",
            icon: "tal-tri.png",
            quantity: 1,
          },
        ];
      }

      function renderBookInventory() {
        const grid = document.getElementById("rwBookInventoryGrid");
        if (!grid) return;

        grid.innerHTML = "";

        const items = BOOK_STATE.inventory;
        const maxSlots = 12;
        const safeItems = Array.isArray(items) ? items : [];

        safeItems.forEach((item) => {
          const slot = document.createElement("div");
          slot.className = "rw-inventory-slot";

          if (item && item.icon) {
            const img = document.createElement("img");
            img.src = item.icon;
            img.alt = item.name || "Item";
            img.className = "rw-inventory-item-icon";
            img.dataset.itemId = item.id;

            // Click to open Use / Description menu (book context)
            if (window.rwOpenItemMenu) {
              img.addEventListener("click", () =>
                window.rwOpenItemMenu(item, { origin: "book" })
              );
            }

            slot.appendChild(img);
          }

          if (item && item.quantity && item.quantity > 1) {
            const badge = document.createElement("span");
            badge.className = "rw-inventory-qty";
            badge.textContent = item.quantity;
            slot.appendChild(badge);
          }

          grid.appendChild(slot);
        });

        // Fill empty slots
        for (let i = safeItems.length; i < maxSlots; i++) {
          const empty = document.createElement("div");
          empty.className = "rw-inventory-slot";
          grid.appendChild(empty);
        }
      }

      // --- SYSTEM MESSAGE ---
      function setSystemMessage(text, kind = "warning") {
        const el = document.getElementById("rwBookSystemMessage");
        if (!el) return;
        if (!text) {
          el.classList.add("d-none");
          el.textContent = "";
          return;
        }
        el.classList.remove("d-none");
        el.textContent = text;
        el.classList.toggle("text-warning", kind === "warning");
        el.classList.toggle("text-success", kind === "success");
        el.classList.toggle("text-danger", kind === "danger");
      }

      // --- BOOK CONTEXT: inventory item use handler ---
      // Called from app.js via handleItemUse(..., { origin: "book" })
      window.rwBookHandleItemUse = function (item) {
        if (!item || !item.id) return;

        const pageId = BOOK_STATE.currentPageId;
        const page = BOOK_PAGES[pageId];

        // The talisman has special behavior
        if (item.id === TALISMAN_ITEM_ID) {
          if (page && page.requiresTalisman) {
            if (!BOOK_STATE.talismanUsedPages[pageId]) {
              BOOK_STATE.talismanUsedPages[pageId] = true;
            }
            setSystemMessage(
              "The talisman warms in your hand. Light seeps into the waiting ward.",
              "success"
            );
            renderPage(pageId); // re-render so success text + choices unlock
          } else {
            setSystemMessage(
              "You lift the talisman, but the wards here stay quiet. Nothing happens.",
              "warning"
            );
          }
          return;
        }

        // Any other item (for now): nothing happens
        setSystemMessage(
          "You try to use that here, but the scene doesn‚Äôt respond. Nothing happens.",
          "danger"
        );
      };

      // --- PAGE RENDERING ---
      function renderPage(pageId) {
        const page = BOOK_PAGES[pageId];
        if (!page) return;

        BOOK_STATE.currentPageId = pageId;

        const titleEl = document.getElementById("rwBookPageTitle");
        const bodyEl = document.getElementById("rwBookPageBody");
        const imgEl = document.getElementById("rwBookImage");
        const metaEl = document.getElementById("rwBookPageMeta");
        const dropZone = document.getElementById("rwBookDropHotspot");

        if (titleEl) titleEl.textContent = page.title || "";
        if (metaEl) metaEl.textContent = "Page " + pageId;

        // Build body HTML with contextual reactions
        let bodyHtml = page.body || "";
        const lastKey = BOOK_STATE.lastChoiceKey;

        // Page 2 reacts to how you entered (from Page 1)
        if (pageId === "2") {
          if (lastKey === "p1_cautious") {
            bodyHtml += `
              <p>
                Mira‚Äôs gaze tracks the way you hover just inside the threshold.
                One corner of her mouth lifts.
                <span class="rw-intro-dialog">‚ÄúGood,‚Äù</span> she says quietly.
                <em>‚ÄúThe Manor respects caution more than bravado.‚Äù</em>
              </p>
            `;
          } else if (lastKey === "p1_belong") {
            bodyHtml += `
              <p>
                You move as if this place has always been yours.
                For a heartbeat, something like recognition flickers in Mira‚Äôs eyes.
                <span class="rw-intro-dialog">‚ÄúYou walk like someone who‚Äôs been here before,‚Äù</span> she murmurs.
              </p>
            `;
          } else if (lastKey === "p1_ask_who") {
            bodyHtml += `
              <p>
                The fact that you stopped to ask her name first seems to soften her.
                <span class="rw-intro-dialog">‚ÄúMost people let the house speak before they let me,‚Äù</span> she says.
                <em>‚ÄúThank you for the courtesy.‚Äù</em>
              </p>
            `;
          }
        }

        // Page 3 reacts to what you asked / did on Page 2
        if (pageId === "3") {
          if (lastKey === "p2_ask_anchor") {
            bodyHtml += `
              <p class="rw-intro-dialog">
                ‚ÄúYou asked what it means to be an anchor,‚Äù Mira says as you walk.
                ‚ÄúIt means the Manor can lean some of its weight on you without breaking you‚Äîor itself.‚Äù
              </p>
              <p>
                Her fingers brush the air near the glowing door.
                <em>‚ÄúThe wards need a mind to steady them. An anchor is the one who keeps them from tearing holes in the world when they panic.‚Äù</em>
              </p>
            `;
            BOOK_STATE.flags.askedAnchor = true;
          } else if (lastKey === "p2_ask_wards") {
            bodyHtml += `
              <p class="rw-intro-dialog">
                ‚ÄúYou felt it, didn‚Äôt you,‚Äù she says. ‚ÄúThe wards are fraying.
                They wake at the wrong times, sleep through the right ones.
                Something is pulling at them from beneath the Underhall.‚Äù
              </p>
              <p>
                Her jaw tightens. <em>‚ÄúI‚Äôve been patching them alone for years.
                But they don‚Äôt want just me anymore. They want someone the house chose.‚Äù</em>
              </p>
            `;
            BOOK_STATE.flags.askedWards = true;
          } else if (lastKey === "p2_touch_talisman") {
            bodyHtml += `
              <p>
                Mira‚Äôs eyes drop briefly to your hand where you touched the talisman.
                The metal still hums faintly.
                <span class="rw-intro-dialog">‚ÄúIt answers you quickly,‚Äù</span> she notes.
                <em>‚ÄúThat‚Äôs rare. Most anchors have to earn that kind of trust.‚Äù</em>
              </p>
            `;
            BOOK_STATE.flags.touchedTalismanEarly = true;
          }
        }

        // Page 9 reacts to whether you took or refused the echo
        if (pageId === "9") {
          if (BOOK_STATE.flags.tookFeather) {
            bodyHtml += `
              <p>
                The echo you pulled into yourself still crackles under your skin. Every time the floor tilts,
                you feel the vault tug at your balance, testing how much of its memory you can carry without breaking.
              </p>
              <p>
                The lanterns seem to approve. Their flames lean toward you, bright and intent,
                as if the house has decided you‚Äôre the kind of anchor who says <em>yes</em> when it asks too much.
              </p>
            `;
          } else if (BOOK_STATE.flags.refusedFeather) {
            bodyHtml += `
              <p>
                A faint coolness lingers where the feather waited. When the corridor shivers, you feel the absence
                of that echo as clearly as its weight might have been‚Äîa space you chose to keep for yourself.
              </p>
              <p>
                The lanterns burn steady instead of flaring. The Manor files that away:
                an anchor who will hold the line, even against the house itself.
              </p>
            `;
          }
        }

        // Page 12 reacts to the anchor stance chosen on Page 11
        if (pageId === "12") {
          const focus = BOOK_STATE.flags.anchorFocus;
          if (focus === "anchor_people") {
            bodyHtml += `
              <p>
                Somewhere in the square below, a window latch lifts of its own accord and a frightened heart
                suddenly finds it easier to breathe. The Manor routes its first trust in you toward the people
                walking its streets.
              </p>
            `;
          } else if (focus === "anchor_house") {
            bodyHtml += `
              <p>
                Deep in the foundations, an old ward sighs in relief. Cracked lines knit the slightest bit tighter
                as the Manor leans more of its weight onto you, certain you won‚Äôt flinch when it shows you the worst of itself.
              </p>
            `;
          } else if (focus === "anchor_between") {
            bodyHtml += `
              <p>
                The tug from town and house evens out, neither winning, neither ignored.
                For a moment the whole weave of Ravenwood balances on the point of your choice‚Äî
                a promise to keep every side from swallowing the other.
              </p>
            `;
          }
        }

        if (bodyEl) {
          bodyEl.innerHTML = bodyHtml;
        }

        if (imgEl) {
          if (page.image) {
            imgEl.src = page.image;
            imgEl.style.display = "";
          } else {
            imgEl.style.display = "none";
          }
        }

        const needsTalisman = !!page.requiresTalisman;
        const alreadyUsed = !!BOOK_STATE.talismanUsedPages[pageId];

        // Hotspot currently unused; keep hidden
        if (dropZone) {
          dropZone.classList.add("d-none");
        }

        if (needsTalisman && alreadyUsed && page.dropSuccessText && bodyEl) {
          const extra = document.createElement("p");
          extra.className = "rw-body mt-2";
          extra.innerHTML = `<em>${page.dropSuccessText}</em>`;
          bodyEl.appendChild(extra);
          setSystemMessage("The talisman answered. New paths are open.", "success");
        }

        renderChoicesForPage(pageId);

        // Save progress whenever we fully render this page
        saveBookProgress(pageId, { completed: pageId === "12" });
      }

      function renderChoicesForPage(pageId) {
        const page = BOOK_PAGES[pageId];
        if (!page) return;

        const choicesEl = document.getElementById("rwBookChoices");
        if (!choicesEl) return;

        const needsTalisman = !!page.requiresTalisman;
        const alreadyUsed = !!BOOK_STATE.talismanUsedPages[pageId];

        choicesEl.innerHTML = "";

        if (!Array.isArray(page.choices) || !page.choices.length) {
          const p = document.createElement("p");
          p.className = "small text-muted";
          p.textContent = "There are no choices here yet.";
          choicesEl.appendChild(p);
          return;
        }

        page.choices.forEach((choice) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "btn rw-btn-main w-100";
          btn.textContent = choice.text;

          if (needsTalisman && !alreadyUsed) {
            btn.disabled = true;
          }

          btn.addEventListener("click", () => {
            // Remember what the player picked
            if (choice.key) {
              BOOK_STATE.lastChoiceKey = choice.key;

              // Track some broader flags based on page + choice
              if (pageId === "1") {
                BOOK_STATE.flags.entryStyle = choice.key;
              }

              if (pageId === "6") {
                if (choice.key === "take_feather") {
                  BOOK_STATE.flags.tookFeather = true;
                  BOOK_STATE.flags.refusedFeather = false;
                } else if (choice.key === "leave_feather") {
                  BOOK_STATE.flags.refusedFeather = true;
                  BOOK_STATE.flags.tookFeather = false;
                }
              }

              if (pageId === "11") {
                BOOK_STATE.flags.anchorFocus = choice.key;
              }
            } else {
              BOOK_STATE.lastChoiceKey = null;
            }

            if (choice.to && BOOK_PAGES[choice.to]) {
              renderPage(choice.to);
              window.scrollTo({ top: 0, behavior: "smooth" });
            }
          });

          choicesEl.appendChild(btn);
        });

        if (needsTalisman && !alreadyUsed) {
          setSystemMessage(
            page.dropHint ||
              "The wall is still waiting. Use your talisman here before you choose your next step.",
            "warning"
          );
        } else {
          // Clear any lingering message if this page doesn't need the talisman
          setSystemMessage(null);
        }
      }

      // --- INVENTORY TOGGLE CONTROLS ---
      function initInventoryToggle() {
        const toggleBtn = document.getElementById("rwBookInventoryToggle");
        const closeBtn = document.getElementById("rwBookInventoryClose");
        const panel = document.getElementById("rwBookInventoryPanel");
        if (!toggleBtn || !panel) return;

        function showPanel() {
          panel.classList.remove("d-none");
        }
        function hidePanel() {
          panel.classList.add("d-none");
        }

        toggleBtn.addEventListener("click", () => {
          if (panel.classList.contains("d-none")) {
            showPanel();
          } else {
            hidePanel();
          }
        });

        if (closeBtn) {
          closeBtn.addEventListener("click", hidePanel);
        }
      }

      // --- INIT ON LOAD ---
      document.addEventListener("DOMContentLoaded", async () => {
        // 1) Ensure a logged-in Supabase user
        try {
          const { data, error } = await supabaseClient.auth.getUser();
          if (error || !data || !data.user || !data.user.email) {
            window.location.href = "login.html";
            return;
          }
          currentBookEmail = data.user.email.toLowerCase();

          // 2) Load their character row
          try {
            currentBookChar = await fetchCharacterByEmail(currentBookEmail);
          } catch (e) {
            console.error("Could not load character for book:", e);
          }
        } catch (e) {
          console.error("Supabase auth error in book:", e);
        }

        // 3) Seed inventory (prefer Supabase)
        if (currentBookChar && Array.isArray(currentBookChar.inventory)) {
          BOOK_STATE.inventory = [...currentBookChar.inventory];
        } else {
          BOOK_STATE.inventory = loadBookInventory();
        }
        renderBookInventory();

        // Inventory UI
        initInventoryToggle();

        // 4) Decide starting page (resume if possible)
        let startPage = "1";
        if (
          currentBookChar &&
          currentBookChar.book1_last_page &&
          BOOK_PAGES[currentBookChar.book1_last_page]
        ) {
          startPage = currentBookChar.book1_last_page;
        }

        BOOK_STATE.currentPageId = startPage;

        // Mark as started & save initial progress
        await saveBookProgress(startPage);

        // Render starting page
        renderPage(startPage);
      });
    })();
  </script>
</body>
</html>
