<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wards of the Manor Â· Ravenwood Â· Book I</title>

  <!-- Main Ravenwood styles -->
  <link rel="stylesheet" href="style.css" />

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    crossorigin="anonymous"
  />

  <!-- Page-specific helpers (keep small; most styling lives in style.css) -->
  <style>
    body.rw-bg {
      background: radial-gradient(circle at top, #111827 0, #020617 60%);
      min-height: 100vh;
    }

    .rw-book-shell {
      max-width: 920px;
      margin: 0 auto;
    }

    .rw-book-image-frame {
      position: relative;
      border-radius: 1rem;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: radial-gradient(circle at top, #0f172a 0, #020617 55%);
      min-height: 220px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .rw-book-image-frame img {
      width: 100%;
      height: auto;
      object-fit: cover;
      display: block;
    }

    .rw-book-page-meta {
      font-size: 0.8rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    /* Inventory panel in-book */
    #rwBookInventoryPanel {
      max-width: 520px;
      margin: 0 auto 1.25rem;
      padding: 0.75rem 0.75rem 0.25rem;
      border-radius: 0.9rem;
      background: radial-gradient(circle at top left, #020617 0, #020617 45%, #030712 100%);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .rw-book-system-msg {
      min-height: 1.2rem;
    }

    @media (max-width: 768px) {
      .rw-book-image-frame { min-height: 180px; }
      #rwBookInventoryPanel { width: 100%; }
    }
  </style>

  <style>
    .rw-choice-echo strong { letter-spacing: .04em; }
  </style>

</head>
<body class="rw-bg" data-page="book1">
  <nav class="navbar navbar-expand-lg rw-navbar border-bottom">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="ravenwood.html">Ravenwood</a>

      <span class="navbar-text small text-muted ms-3">
        Wards of the Manor Â· Book I
      </span>

      <a href="ravenwood.html" class="btn btn-sm rw-btn-main ms-auto">
        âŸµ Town &amp; Manor
      </a>
    </div>
  </nav>

    <main class="py-4 py-md-5">
    <div class="container rw-book-shell">
      <div class="rw-card p-4 p-md-5 shadow-lg">

        <header class="mb-4 text-center">
          <p class="rw-tagline text-uppercase mb-1">Interactive Ravenwood Story</p>
          <h1 class="rw-title mb-2">Wards of the Manor</h1>
          <p class="rw-body mb-0">
            Book I Â· Your choices shape how the Manor remembers you.
            Read slowly. Follow what calls. Let Ravenwood answer in its own time.
          </p>
        </header>

        <hr class="my-4" />

        <!-- Page meta + Inventory toggle -->
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="rw-book-page-meta" id="rwBookPageMeta">Page 1</span>

          <button id="rwBookInventoryToggle" class="btn btn-outline-light btn-sm">
            ğŸ‘œ Open Inventory
          </button>
        </div>

        <!-- Inventory panel -->
        <div id="rwBookInventoryPanel" class="d-none">
          <div class="d-flex justify-content-between align-items-center">
            <span class="small text-muted">
              Tap an item for options (<strong>Use</strong> / <strong>Description</strong>).
            </span>
            <button class="btn btn-link btn-sm text-decoration-none text-muted" id="rwBookInventoryClose">
              Close âœ•
            </button>
          </div>

          <div id="rwBookInventoryGrid" class="rw-inventory-grid mt-2"></div>
        </div>

        <!-- Page container -->
        <article id="rwBookPageContainer" class="rw-book-body">

          <!-- Image slot -->
          <div class="mb-4">
            <div class="rw-book-image-frame">
              <img
                id="rwBookImage"
                src=""
                alt="Ravenwood scene"
                onerror="this.style.display='none';"
              />
            </div>
          </div>

          <h2 id="rwBookPageTitle" class="rw-title fs-4 mb-3"></h2>
          <div id="rwBookPageBody" class="rw-body mb-4"></div>

          <div id="rwBookSystemMessage" class="rw-book-system-msg small text-warning mb-2 d-none"></div>

          <div id="rwBookChoices" class="d-flex flex-column gap-2 mb-3"></div>

        </article>

      </div>
    </div>
  </main>

    <!-- Item Action Modal (for book inventory) -->
  <div class="modal fade" id="rwBookItemModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rw-card">
        <div class="modal-header border-0">
          <h5 class="modal-title rw-card-title" id="rwBookItemModalTitle">Item</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <p class="rw-body mb-3" id="rwBookItemModalDesc"></p>

          <div class="d-flex gap-2">
            <button class="btn rw-btn-main w-50" id="rwBookItemUseBtn">Use</button>
            <button class="btn btn-outline-light w-50" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

    <!-- Bootstrap JS -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    crossorigin="anonymous"
  ></script>

  <!-- Supabase JS (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Ravenwood core logic (Supabase client, inventory helpers, HP/Mana, stats, etc.) -->
  <script src="app.js"></script>

    <script>
(function () {
  // ----------------------------
  // Book I State
  // ----------------------------
  const BOOK_STATE = {
    currentPageId: "1",
    flags: {},
    lastChoiceKey: null,
    lastRoll: null,
  };

  // expose for debugging (optional)
  window.BOOK_STATE = BOOK_STATE;

  // ----------------------------
  // Manor Attitude + Ward Heat
  // ----------------------------
  function getSavedNumberFlag(key, fallback = 0) {
    const v = BOOK_STATE.flags?.[key];
    const n = Number(v);
    return Number.isFinite(n) ? n : fallback;
  }

  function setNumberFlag(key, value) {
    if (!BOOK_STATE.flags) BOOK_STATE.flags = {};
    BOOK_STATE.flags[key] = Number(value) || 0;
  }

  function getManorAttitudeScore() {
    return getSavedNumberFlag("__attitudeScore", 0);
  }

  function setManorAttitudeScore(score) {
    setNumberFlag("__attitudeScore", score);
    window.rwManorAttitude = getManorAttitudeLabel();
  }

  function bumpManorAttitude(delta) {
    const next = getManorAttitudeScore() + (Number(delta) || 0);
    setManorAttitudeScore(next);
    return next;
  }

  function getManorAttitudeLabel() {
    const s = getManorAttitudeScore();
    if (s >= 2) return "welcoming";
    if (s <= -2) return "wary";
    return "watchful";
  }

  function getWardHeat() {
    return getSavedNumberFlag("__wardHeat", 0);
  }

  function setWardHeat(v) {
    const clamped = Math.max(0, Math.min(3, Number(v) || 0));
    setNumberFlag("__wardHeat", clamped);
    return clamped;
  }

  function bumpWardHeat(delta) {
    return setWardHeat(getWardHeat() + (Number(delta) || 0));
  }

  // ----------------------------
  // D&D-ish Rolls
  // ----------------------------
  function getPlayerStat(statKey) {
    const s = window.rwStats || window.ravenwoodStats || null;
    if (s && typeof s === "object" && s[statKey] != null) return Number(s[statKey]) || 8;

    try {
      const raw = localStorage.getItem("ravenwoodStats");
      if (raw) {
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed === "object" && parsed[statKey] != null) return Number(parsed[statKey]) || 8;
      }
    } catch {}

    return 8;
  }

  function statModFromScore(score) {
    const n = Number(score) || 0;
    return Math.floor((n - 10) / 2);
  }

  function d20() {
    return Math.floor(Math.random() * 20) + 1;
  }

  function rollCheck(check) {
    const stat = String(check?.stat || "insight");
    const dc = Number(check?.dc || 10);
    const label = String(check?.label || "Check");

    const score = getPlayerStat(stat);
    const mod = statModFromScore(score);
    const die = d20();
    const total = die + mod;
    const success = total >= dc;

    const result = { label, stat, score, mod, die, dc, total, success };
    BOOK_STATE.lastRoll = result;

    const msg = success ? check?.successMsg : check?.failMsg;
    if (msg) showSystemMessage(String(msg));

    if (success && Number.isFinite(Number(check?.deltaAttitudeSuccess))) bumpManorAttitude(Number(check.deltaAttitudeSuccess));
    if (!success && Number.isFinite(Number(check?.deltaAttitudeFail))) bumpManorAttitude(Number(check.deltaAttitudeFail));

    if (success && Number.isFinite(Number(check?.deltaWardHeatSuccess))) bumpWardHeat(Number(check.deltaWardHeatSuccess));
    if (!success && Number.isFinite(Number(check?.deltaWardHeatFail))) bumpWardHeat(Number(check.deltaWardHeatFail));

    return result;
  }

  // âœ… everything else you already have stays BELOW, still inside this IIFE...



      // Cached references
      const elMeta = document.getElementById("rwBookPageMeta");
      const elTitle = document.getElementById("rwBookPageTitle");
      const elBody = document.getElementById("rwBookPageBody");
      const elChoices = document.getElementById("rwBookChoices");
      const elImage = document.getElementById("rwBookImage");
      const elSys = document.getElementById("rwBookSystemMessage");

      // Inventory UI
      const invToggle = document.getElementById("rwBookInventoryToggle");
      const invPanel = document.getElementById("rwBookInventoryPanel");
      const invClose = document.getElementById("rwBookInventoryClose");
      const invGrid = document.getElementById("rwBookInventoryGrid");

      // Item modal
      const itemModalEl = document.getElementById("rwBookItemModal");
      const itemModal = itemModalEl ? new bootstrap.Modal(itemModalEl) : null;
      const itemModalTitle = document.getElementById("rwBookItemModalTitle");
      const itemModalDesc = document.getElementById("rwBookItemModalDesc");
      const itemUseBtn = document.getElementById("rwBookItemUseBtn");

      let selectedItem = null;

      // ----------------------------
      // Page content (start small)
      // Youâ€™ll expand BOOK_PAGES next.
      // ----------------------------
      const BOOK_PAGES = {
        "1": {
          title: "The Road That Remembers",
          image: "b1-p1.png",
          body: `
            <p>Fog gathers low, clinging to your boots as though the earth itself is reluctant to let you pass.</p>
            <p>Lanterns along the old road flickerâ€”not randomly, but in sequence. One after another. A measured response.</p>
            <p>You did not plan to come to Ravenwood. And yet here you are.</p>
            <p>The manor rises ahead, dark stone veined with moonlight. It does not loom. It <em>waits</em>.</p>
          `,
          choices: [
            { text: "Slow your pace and listen to the silence.", to: "2", key: "p1_listen" },
            { text: "Walk as if you belong here.", to: "2", key: "p1_belong" },
            { text: "Stop at the threshold stone and breathe.", to: "2", key: "p1_breathe" },
          ],
        },

        "2": {
          title: "The Door That Breathes",
          image: "b1-p2.png",
          body: `
            <p>The door opens before you reach for it.</p>
            <p>Warm light spills outward, cutting a soft line through the fog. The scent inside is old stone, candle smoke, and rain soaked into walls for centuries.</p>
            <p>A woman with silver hair waits just beyond the threshold, gaze sharp with long practice.</p>
            <p class="rw-intro-dialog">â€œYou made it,â€ she says. Not welcome. Not who are you. <em>You made it.</em></p>
          `,
          choices: [
            { text: "Step inside.", to: "3", key: "p2_step_in" },
            { text: "Ask who she is first.", to: "3", key: "p2_ask_who" },
            { text: "Touch the talisman and watch her reaction.", to: "3", key: "p2_talisman" },
          ],
        },

        "3": {
          title: "Mira Ashbourne",
          image: "b1-p3.png",
          body: `
            <p>The doors close behind you with a sound that echoes too long.</p>
            <p class="rw-intro-dialog">â€œMira Ashbourne,â€ she says. â€œKeeper of the Manor. Ward-tender. Listener.â€</p>
            <p>Her eyes flick once to your chest, where metal rests warm as a heartbeat.</p>
            <p class="rw-intro-dialog">â€œYou didnâ€™t come here by accident,â€ she adds. â€œThe road doesnâ€™t allow it.â€</p>
          `,
          choices: [
            { text: "Follow her deeper into the manor.", to: "4", key: "p3_follow" },
            { text: "Ask what the talisman is supposed to do.", to: "4", key: "p3_ask_talisman" },
          ],
        },

        // ============================
// BOOK I Â· Pages 4â€“10 (paste into BOOK_PAGES)
// ============================

"4": {
  title: "The Closing Doors",
  image: "b1-p4.png",
  body: `
    <p>The doors shut behind you.</p>
    <p>Not slammed. Not forced. Simply <em>closed</em>â€”with the calm finality of something that already decided you were staying.</p>
    <p>For a moment you listen for a latch, a lock, the sound of a mechanism.</p>
    <p>There is none.</p>
    <p>The silence that follows is long enough for your thoughts to turn sharp.</p>
    <p><em>I can still leave.</em></p>
    <p>The manor does not respond.</p>
    <p>But the air changes slightly, as if the house is now paying closer attention to the shape of your breathing.</p>
  `,
  choices: [
    { text: "Follow Mira deeper into the manor.", to: "5", key: "p4_follow" },
    { text: "Turn back and test the door anyway.", to: "5", key: "p4_test_door" },
  ],
},

"5": {
  title: "The Hall of Faces",
  image: "b1-p5.png",
  body: `
    <p>Mira leads you into a long corridor lit by low lanterns that hang from carved stone pillars.</p>
    <p>Portraits line the wallsâ€”dozens of them, maybe moreâ€”frames tarnished with age, corners softened by time.</p>
    <p>At first glance, their faces are indistinct, blurred as if the painter refused to finish them.</p>
    <p>But their eyes are sharp.</p>
    <p>One set follows you too closely, tracking your movement with an attention that feels uncomfortably personal.</p>
    <p>You slow without meaning to.</p>
    <p class="rw-intro-dialog">â€œThey wonâ€™t speak,â€ Mira says, as if answering a question you didnâ€™t ask. â€œNot unless the house asks them to.â€</p>
    <p>You look again.</p>
    <p>And realize something worse.</p>
    <p>It isnâ€™t that the portraits are watching you.</p>
    <p>Itâ€™s that they are watching <em>to see what the manor will do with you.</em></p>
  `,
  choices: [
    { text: "Keep your eyes forward and keep walking.", to: "6", key: "p5_forward" },
    { text: "Look directly at the portrait that follows you.", to: "6", key: "p5_stare_back" },
    { text: "Ask Mira who these people were.", to: "6", key: "p5_ask_portraits" },
  ],
},

"6": {
  title: "The Manor Takes Your Measure",
  image: "b1-p6.png",
  body: (S) => {
    const f = S.flags || {};
    const attitude = getManorAttitudeLabel();
    const heat = getWardHeat();

    const opener =
      f.p5_reach_out ? `<p>Miraâ€™s hand is still on your wristâ€”only for a secondâ€”then she releases you with a look that says <em>you felt that too</em>.</p>` :
      f.p5_stare_back ? `<p>You can still feel the weight of the portraitâ€™s gaze like cold fingers at the base of your skull.</p>` :
      `<p>The corridor behind you seems to swallow its own echoes. The manor has noticed youâ€¦ and kept its opinion to itself.</p>`;

    const manorMood =
      attitude === "welcoming" ? `<p class="rw-intro-dialog">â€œItâ€™sâ€¦ calmer,â€ Mira murmurs, surprised. â€œLike itâ€™s letting you breathe.â€</p>` :
      attitude === "wary" ? `<p class="rw-intro-dialog">Miraâ€™s voice drops to a whisper. â€œDonâ€™t give it a reason to tighten.â€</p>` :
      `<p class="rw-intro-dialog">â€œWatchful,â€ Mira says. â€œThatâ€™s better than hostile.â€</p>`;

    const heatLine =
      heat >= 2 ? `<p>A thin, invisible pressure slides over your skin as you walkâ€”like stepping through webbing you canâ€™t see.</p>` :
      `<p>The air carries a faint mineral tang, as if old stone has been rubbed raw.</p>`;

    return `
      ${opener}
      <p>Mira walks a pace ahead, lantern low, as if the light itself could be overheard.</p>
      <p class="rw-intro-dialog">â€œRule one,â€ she says, without turning. â€œDonâ€™t lie to the house.â€</p>
      <p class="rw-intro-dialog">â€œRule two: donâ€™t challenge it unless youâ€™re ready to lose.â€</p>
      ${heatLine}
      ${manorMood}
      <p>The next archway is carved with overlapping sigilsâ€”wards braided like rope.</p>
      <p>Some of them look freshly repaired.</p>
      <p class="rw-intro-dialog">â€œPages six through ten are the part where most people decide theyâ€™re brave,â€ Mira adds. â€œOr decide theyâ€™re smart. Try to be neither. Try to be <em>aware</em>.â€</p>
    `;
  },
  choices: [
    {
      text: "Search the archway for a 'safe seam' in the wardwork. (Insight DC 12)",
      to: "7",
      key: "p6_search_seam",
      check: {
        label: "Search",
        stat: "insight",
        dc: 12,
        successMsg: "You spot a faint break in the sigil braidâ€”an intentional 'breathing stitch.'",
        failMsg: "The runes blur for a heartbeat. You realize you were looking where it wanted you to look.",
        deltaAttitudeSuccess: +1,
        deltaAttitudeFail: -1,
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Ask Mira what happens if you lie to the house. (Presence DC 11)",
      to: "7",
      key: "p6_ask_lie",
      check: {
        label: "Persuasion",
        stat: "presence",
        dc: 11,
        successMsg: "Mira answersâ€”directly. The manor seems to approve honest questions.",
        failMsg: "Miraâ€™s mouth tightens. â€œNot here.â€ The lantern flame shrinks.",
        deltaAttitudeSuccess: +1,
        deltaAttitudeFail: -1,
      },
    },
    {
      text: "Say nothing. Match Miraâ€™s pace. Let the manor listen.",
      to: "7",
      key: "p6_silent",
      deltaAttitude: 0,
    },
  ],
},

"7": {
  title: "First Ward: The Listening Glyphs",
  image: "b1-p7.png",
  body: (S) => {
    const f = S.flags || {};
    const attitude = getManorAttitudeLabel();

    const seam =
      f.p6_search_seam_success ? `<p>You angle your steps toward the wardâ€™s breathing stitch. The pressure eases, just slightlyâ€”like the house acknowledges youâ€™re paying attention.</p>` :
      f.p6_search_seam_fail ? `<p>You step forward and feel the ward <em>notice</em> the motion. Not attack. Justâ€¦ record.</p>` :
      `<p>The braided sigils over the archway hum in a pitch you feel more than hear.</p>`;

    const miraAnswer =
      f.p6_ask_lie_success ? `<p class="rw-intro-dialog">â€œIf you lie,â€ Mira says, â€œit rewrites you as a threat. And then it treats you like one.â€</p>` :
      f.p6_ask_lie_fail ? `<p class="rw-intro-dialog">â€œLater,â€ she repeats, eyes on the runes. â€œIf weâ€™re still welcomed.â€</p>` :
      ``;

    const manorTone =
      attitude === "welcoming" ? `<p>The lantern light stretches farther than it should, as if the corridor is offering you a clearer view.</p>` :
      attitude === "wary" ? `<p>The shadows gather closer to the floor, like theyâ€™ve been told to keep their hands where you canâ€™t see them.</p>` :
      `<p>The corridor holds steadyâ€”neutral, listening.</p>`;

    return `
      ${seam}
      ${miraAnswer}
      ${manorTone}
      <p>Halfway down the corridor, the stones underfoot change textureâ€”subtle, but deliberate.</p>
      <p>Mira stops. Her free hand rises, palm outward.</p>
      <p class="rw-intro-dialog">â€œFirst ward,â€ she whispers. â€œListening glyphs. It hears intent through your feet.â€</p>
      <p>The sigils arenâ€™t painted. Theyâ€™re <em>in</em> the stone, like scars.</p>
      <p class="rw-intro-dialog">â€œWalk like you belong,â€ Mira adds. â€œNot like youâ€™re sneaking. Not like youâ€™re storming.â€</p>
    `;
  },
  choices: [
    {
      text: "Cross normally, steady and honest. (Will DC 11)",
      to: "8",
      key: "p7_cross_honest",
      check: {
        label: "Composure",
        stat: "will",
        dc: 11,
        successMsg: "Your heartbeat slows. The ward hears no threat in you.",
        failMsg: "Your fear spikesâ€”just enough. The glyphs drink it like wine.",
        deltaAttitudeSuccess: +1,
        deltaAttitudeFail: -1,
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Study the glyph rhythm and step between the 'beats.' (Agility DC 12)",
      to: "8",
      key: "p7_step_between",
      check: {
        label: "Dexterity",
        stat: "agility",
        dc: 12,
        successMsg: "You move with a dancerâ€™s timing. The wardâ€™s attention slides past you.",
        failMsg: "Your heel lands on the wrong stone. The air snaps tightâ€”warning, not punishment.",
        deltaAttitudeSuccess: 0,
        deltaAttitudeFail: -1,
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Murmur a respectful greeting to the house as you pass. (Presence DC 12)",
      to: "8",
      key: "p7_greet_house",
      check: {
        label: "Etiquette",
        stat: "presence",
        dc: 12,
        successMsg: "The lantern flame lifts. The manor doesnâ€™t answerâ€¦ but it listens differently.",
        failMsg: "Your words feel swallowed. Mira gives you a quick, warning lookâ€”timing matters.",
        deltaAttitudeSuccess: +2,
        deltaAttitudeFail: -1,
      },
    },
  ],
},

"8": {
  title: "Second Ward: The Breath-Tithe",
  image: "b1-p8.png",
  body: (S) => {
    const f = S.flags || {};
    const attitude = getManorAttitudeLabel();
    const heat = getWardHeat();

    const last =
      f.p7_cross_honest_success ? `<p>You cross the listening stones without flinching. Miraâ€™s shoulders loosen a fraction.</p>` :
      f.p7_step_between_success ? `<p>Your timing holds. The corridorâ€™s attention slips away like mist.</p>` :
      f.p7_greet_house_success ? `<p>The greeting lands like a coin on a table: acknowledged.</p>` :
      (f.p7_cross_honest_fail || f.p7_step_between_fail || f.p7_greet_house_fail) ? `<p>The glyphs remember you. You feel it in the way the air stays a little too tight.</p>` :
      `<p>The corridor releases you into a narrow stairwell.</p>`;

    const heatWarn =
      heat >= 2 ? `<p class="rw-intro-dialog">â€œItâ€™s warmed up,â€ Mira mutters. â€œWeâ€™re on the edge of â€˜wary.â€™ Keep your breath.â€</p>` :
      `<p class="rw-intro-dialog">â€œNext is a soft ward,â€ Mira says. â€œSoft doesnâ€™t mean kind.â€</p>`;

    const attitudeLine =
      attitude === "welcoming" ? `<p>The air here is coolerâ€”cleanerâ€”like the manor is letting you borrow comfort.</p>` :
      attitude === "wary" ? `<p>The stairwell smells faintly of candle smoke and old iron. The manor is not offering comfort now.</p>` :
      `<p>The stairwell is still. Too still.</p>`;

    return `
      ${last}
      <p>The stairwell bends out of sightâ€”stone steps worn smooth by centuries of careful feet.</p>
      ${attitudeLine}
      <p>Halfway down, the lantern flame narrowsâ€¦ and begins to pulse in time with your breathing.</p>
      ${heatWarn}
      <p class="rw-intro-dialog">â€œBreath-tithe,â€ she explains. â€œIt counts you. If you panic, it takes more.â€</p>
      <p>Your throat tightens as if the air has learned your name.</p>
    `;
  },
  choices: [
    {
      text: "Control your breathing and descend slowly. (Will DC 12)",
      to: "9",
      key: "p8_breath_control",
      check: {
        label: "Fear Save",
        stat: "will",
        dc: 12,
        successMsg: "You keep your breath steady. The pulsing lantern relaxes.",
        failMsg: "Your lungs hitch. The ward 'collects'â€”a cold pressure at your ribs.",
        deltaAttitudeSuccess: +1,
        deltaAttitudeFail: -2,
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Count the pulses and match them like a metronome. (Insight DC 12)",
      to: "9",
      key: "p8_match_pulse",
      check: {
        label: "Pattern",
        stat: "insight",
        dc: 12,
        successMsg: "You find the wardâ€™s rhythm. You descend inside it, not against it.",
        failMsg: "The rhythm changes mid-count. Your mind stumblesâ€”and the ward notes it.",
        deltaAttitudeSuccess: +1,
        deltaAttitudeFail: -1,
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Grip the railing and force yourself downward. (Might DC 11)",
      to: "9",
      key: "p8_force_down",
      check: {
        label: "Athletics",
        stat: "might",
        dc: 11,
        successMsg: "You move with stubborn certainty. The ward has less to take from you.",
        failMsg: "The railing feels slickâ€”almost alive. You lurch, breath breaking.",
        deltaAttitudeSuccess: 0,
        deltaAttitudeFail: -1,
        deltaWardHeatFail: +1,
      },
    },
  ],
},

"9": {
  title: "Third Ward: The Name-Thread",
  image: "b1-p9.png",
  body: (S) => {
    const f = S.flags || {};
    const attitude = getManorAttitudeLabel();
    const heat = getWardHeat();

    const outcome =
      f.p8_breath_control_success ? `<p>You reach the bottom with your breath intact. Mira gives you a single, approving nod.</p>` :
      f.p8_match_pulse_success ? `<p>You arrive as the lantern pulse softensâ€”like you solved something without breaking it.</p>` :
      f.p8_force_down_success ? `<p>You descend like a person refusing to be measured. The manor does not like itâ€¦ but it respects the effort.</p>` :
      (f.p8_breath_control_fail || f.p8_match_pulse_fail || f.p8_force_down_fail) ? `<p>You reach the bottom and realize your ribs hurtâ€”not from impact, but from <em>collection</em>. Mira notices. Her jaw tightens.</p>` :
      `<p>The stairwell ends in a small landing of black stone.</p>`;

    const wardHeatLine =
      heat >= 2 ? `<p>A thin silver filament hangs across the next doorwayâ€”so fine you almost miss it. It hums like a plucked nerve.</p>` :
      `<p>A pale filament hangs across the doorwayâ€”fine as spider silk, bright as moonlight.</p>`;

    const manorLine =
      attitude === "welcoming" ? `<p class="rw-intro-dialog">â€œItâ€™s giving you a chance,â€ Mira whispers. â€œDonâ€™t waste it.â€</p>` :
      attitude === "wary" ? `<p class="rw-intro-dialog">â€œCareful,â€ Mira warns. â€œItâ€™s deciding what you are.â€</p>` :
      `<p class="rw-intro-dialog">â€œThis one likes truths,â€ Mira says. â€œSpeak plainly.â€</p>`;

    return `
      ${outcome}
      ${wardHeatLine}
      <p>The thread is anchored to runes carved into the doorframeâ€”older than the rest, sharper, less forgiving.</p>
      <p class="rw-intro-dialog">â€œName-thread,â€ Mira says. â€œIt tests what you call yourself.â€</p>
      ${manorLine}
      <p>Your tongue goes dry as if the air is waiting for your answer.</p>
    `;
  },
  choices: [
    {
      text: "State your name and intent honestly. (Presence DC 12)",
      to: "10",
      key: "p9_name_honest",
      check: {
        label: "Truth",
        stat: "presence",
        dc: 12,
        successMsg: "The filament loosensâ€”acceptance, cautious but real.",
        failMsg: "The filament tightens. Not cuttingâ€”warning. The manor doesnâ€™t like how you said it.",
        deltaAttitudeSuccess: +2,
        deltaAttitudeFail: -2,
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Study the runes and mirror their phrasing. (Insight DC 13)",
      to: "10",
      key: "p9_mirror_runes",
      check: {
        label: "Arcana",
        stat: "insight",
        dc: 13,
        successMsg: "You echo the old structure of permission. The ward recognizes the form.",
        failMsg: "You misread a stroke. The filament snaps against your wristâ€”stinging cold.",
        deltaAttitudeSuccess: +1,
        deltaAttitudeFail: -2,
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Try to pass without speaking. (Agility DC 12)",
      to: "10",
      key: "p9_sneak_thread",
      check: {
        label: "Stealth",
        stat: "agility",
        dc: 12,
        successMsg: "You slip under the filament with breath held. Miraâ€™s expression says: risky, but clean.",
        failMsg: "The filament catches your shoulder. A whisper crawls through your bones: <em>Not welcome.</em>",
        deltaAttitudeSuccess: 0,
        deltaAttitudeFail: -3,
        deltaWardHeatFail: +1,
      },
    },
  ],
},

"10": {
  title: "The Candle Chamber",
  image: "b1-p10.png",
  body: (S) => {
    const f = S.flags || {};
    const attitude = getManorAttitudeLabel();
    const heat = getWardHeat();

    const arrival =
      (f.p9_name_honest_success || f.p9_mirror_runes_success || f.p9_sneak_thread_success)
        ? `<p>The filament releases you with a soft, almost reluctant sigh. The doorway opens into warmer light.</p>`
        : `<p>The filament does not cut youâ€”but it marks you. When the doorway yields, it feels like permission granted under protest.</p>`;

    const chamberMood =
      attitude === "welcoming" ? `<p>The chamber feels strangelyâ€¦ expectant. Not hostile. Like a room that has been waiting for the right person to arrive.</p>` :
      attitude === "wary" ? `<p>The chamber is silent in a way that makes your teeth ache. Every candle flame seems to watch you back.</p>` :
      `<p>The chamber is balancedâ€”still, attentive, measuring.</p>`;

    const heatFlavor =
      heat >= 2 ? `<p>The runes in the floor glow a little too bright. You suspect the wards are only one mistake away from snapping.</p>` :
      `<p>The runes in the floor pulse faintly, patient as tidewater.</p>`;

    const p5callback =
      f.p5_reach_out ? `<p class="rw-intro-dialog">â€œYou already tried to touch it,â€ Mira says softly. â€œSo nowâ€¦ let it touch <em>you</em>.â€</p>` :
      f.p5_stare_back ? `<p class="rw-intro-dialog">Mira glances at the portraits behind you. â€œIf you stare at the old things, they stare back harder.â€</p>` :
      `<p class="rw-intro-dialog">â€œThis is where the house decides what you are to it,â€ Mira says.</p>`;

    return `
      ${arrival}
      ${chamberMood}
      <p>The room is circular, carved from black stone, with a ring of candles on a low altar.</p>
      ${heatFlavor}
      <p>Four flames burn in different colorsâ€”each one steady, each one wrong in its own way.</p>
      ${p5callback}
      <p class="rw-intro-dialog">â€œChoose,â€ she says. â€œNot the one you want. The one that answers when you breathe.â€</p>
      <p>Somewhere above you, the manor shiftsâ€”subtle as a thought changing shape.</p>
    `;
  },
  choices: [
    { text: "Reach for the Wind Candle (Shadow Witch).", to: "11_shadow", key: "class_shadow" },
    { text: "Reach for the Water Candle (Scholar of Runes).", to: "11_rune", key: "class_rune" },
    { text: "Reach for the Stone Candle (Guardian of Gates).", to: "11_guardian", key: "class_guardian" },
    { text: "Reach for the Flame Candle (Seer of Moons).", to: "11_moon", key: "class_moon" },
  ],
},



// ============================
// BOOK I Â· Page 11 â€” Class-Specific Branches
// ============================

"11": {
  title: "After the Name-Thread",
  image: "b1-p11.png",
  body: (S) => {
    const attitude = getManorAttitudeLabel();
    const heat = getWardHeat();

    const tone =
      attitude === "welcoming"
        ? `<p>The air eases, just slightly. The house seemsâ€¦ satisfied.</p>`
        : attitude === "wary"
        ? `<p>The air remains tight. The house has not relaxed its judgment.</p>`
        : `<p>The manor remains watchful, neither opening nor closing itself to you.</p>`;

    return `
      <p>The filament withdraws, not disappearingâ€”just retreating.</p>
      ${tone}
      <p>Mira studies the doorway as the wards settle.</p>
      <p class="rw-intro-dialog">â€œYouâ€™re past the threshold,â€ she says. â€œFor now.â€</p>
    `;
  },
  choices: [
    {
      text: "Ask what the house decided about you. (Presence DC 11)",
      to: "12",
      key: "p11_ask_decision",
      check: {
        stat: "presence",
        dc: 11,
        successMsg: "Mira answers honestly. The manor approves of directness.",
        failMsg: "Mira hesitates. The manor prefers fewer questions right now.",
        deltaAttitudeSuccess: +1,
        deltaAttitudeFail: -1,
      },
    },
    {
      text: "Say nothing and observe the space.",
      to: "12",
      key: "p11_observe",
    },
  ],
},

// ============================
// BOOK I Â· Pages 12â€“16
// ============================

"12": {
  title: "The Pillar Hall",
  image: "b1-p12.png",
  body: `
    <p>Stone pillars rise around you, carved in spirals that seem to shift when unobserved.</p>
    <p>You feel a subtle awarenessâ€”not watching, but measuring.</p>
  `,
  choices: [
    {
      text: "Study the carvings for meaning. (Insight DC 12)",
      to: "13",
      key: "p12_study_pillars",
      check: {
        stat: "insight",
        dc: 12,
        successMsg: "You sense the pillars record presence, not action.",
        failMsg: "The patterns blur. You feel gently dismissed.",
        deltaAttitudeSuccess: +1,
      },
    },
    {
      text: "Walk through without engaging.",
      to: "13",
      key: "p12_ignore",
      deltaWardHeat: 0,
    },
  ],
},

"13": {
  title: "The First Offering",
  image: "b1-p13.png",
  body: `
    <p>A shallow stone basin rests at the center of the hall.</p>
    <p class="rw-intro-dialog">â€œVoluntary,â€ Mira says. â€œBut noted.â€</p>
  `,
  choices: [
    {
      text: "Offer a memory willingly. (Will DC 12)",
      to: "14",
      key: "p13_offer_memory",
      check: {
        stat: "will",
        dc: 12,
        successMsg: "The stone warms beneath your hand.",
        failMsg: "The memory resists. The manor still records the attempt.",
        deltaAttitudeSuccess: +2,
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Offer only a breath.",
      to: "14",
      key: "p13_offer_breath",
    },
  ],
},

"14": {
  title: "What the House Keeps",
  image: "b1-p14.png",
  body: (S) => {
    const heat = getWardHeat();
    return `
      <p>The basin accepts what you give.</p>
      ${
        heat >= 2
          ? "<p>The stone lingers warm longer than expected.</p>"
          : "<p>The basin cools quickly, as if satisfied.</p>"
      }
    `;
  },
  choices: [
    {
      text: "Ask what happens to offerings. (Insight DC 11)",
      to: "15",
      key: "p14_ask_offerings",
      check: {
        stat: "insight",
        dc: 11,
        successMsg: "Mira answers carefully. Some truths are archived.",
        failMsg: "Mira deflects. The house is listening too closely.",
      },
    },
    {
      text: "Move on without asking.",
      to: "15",
      key: "p14_move_on",
    },
  ],
},

"15": {
  title: "The Weight That Follows",
  image: "b1-p15.png",
  body: `
    <p>You leave the hall with a faint pressure between your shoulders.</p>
    <p>Not pain. Not restraint.</p>
    <p>Awareness.</p>
  `,
  choices: [
    {
      text: "Acknowledge the presence silently.",
      to: "16",
      key: "p15_acknowledge",
      deltaAttitude: +1,
    },
    {
      text: "Resist the feeling and push forward. (Will DC 12)",
      to: "16",
      key: "p15_resist",
      check: {
        stat: "will",
        dc: 12,
        successMsg: "You steady yourself. The manor takes note.",
        failMsg: "The pressure deepensâ€”briefly.",
        deltaWardHeatFail: +1,
      },
    },
  ],
},

// ============================
// BOOK I Â· Pages 16â€“30 (mechanics + choices)
// ============================

"16": {
  title: "The Question of Leaving",
  image: "b1-p16.png",
  body: (S) => {
    const attitude = getManorAttitudeLabel();
    const heat = getWardHeat();

    const mood =
      attitude === "welcoming"
        ? `<p>The manor does not push back. It listensâ€”curious, almost patient.</p>`
        : attitude === "wary"
        ? `<p>The air tightens the moment you form the question. The manor is already bracing.</p>`
        : `<p>The silence feels measured, like something counting your words.</p>`;

    const heatLine =
      heat >= 2
        ? `<p>A thin pressure sits behind your ribsâ€”warning you not to speak carelessly.</p>`
        : `<p>The lantern flame holds steady, waiting.</p>`;

    return `
      <p>Mira pauses at the next threshold.</p>
      <p class="rw-intro-dialog">â€œThis is where most people ask if they can leave,â€ she says.</p>
      ${mood}
      ${heatLine}
      <p class="rw-intro-dialog">â€œItâ€™s not the question that matters,â€ Mira adds. â€œItâ€™s <em>why</em> youâ€™re asking it.â€</p>
    `;
  },
  choices: [
    {
      text: "Ask plainly: â€œCan I leave?â€ (Presence DC 12)",
      to: "17",
      key: "p16_can_i_leave",
      check: {
        label: "Directness",
        stat: "presence",
        dc: 12,
        successMsg: "Mira answers without flinching. The manor seems to prefer clean truth.",
        failMsg: "Mira hesitates. The manor is listening too closely for fear.",
        deltaAttitudeSuccess: +1,
        deltaAttitudeFail: -1,
      },
    },
    {
      text: "Ask instead: â€œWhat happens if I try?â€ (Insight DC 12)",
      to: "17",
      key: "p16_what_if_i_try",
      check: {
        label: "Reading the Room",
        stat: "insight",
        dc: 12,
        successMsg: "You catch a flicker in Miraâ€™s eyesâ€”this question matters more.",
        failMsg: "The air shifts. You realize the manor wanted a different question.",
        deltaAttitudeSuccess: +1,
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Say nothing. Let the manor hear your silence.",
      to: "17",
      key: "p16_silence",
      deltaAttitude: 0,
    },
  ],
},

"17": {
  title: "The Corridor That Narrows",
  image: "b1-p17.png",
  body: (S) => {
    const attitude = getManorAttitudeLabel();
    const heat = getWardHeat();
    const f = S.flags || {};

    const answerEcho =
      f.p16_can_i_leave_success
        ? `<p class="rw-intro-dialog">â€œYes,â€ Mira said. â€œBut it will remember how you left.â€</p>`
        : f.p16_can_i_leave_fail
        ? `<p class="rw-intro-dialog">Mira didnâ€™t like how that landed. â€œNot now,â€ she said quietly.</p>`
        : f.p16_what_if_i_try_success
        ? `<p class="rw-intro-dialog">â€œIt closes behind some people,â€ Mira admitted. â€œNot as punishmentâ€”as classification.â€</p>`
        : f.p16_what_if_i_try_fail
        ? `<p class="rw-intro-dialog">Miraâ€™s jaw tightened. â€œCareful.â€</p>`
        : ``;

    const corridor =
      heat >= 2
        ? `<p>The passage ahead feels subtly smallerâ€”like the manor is re-measuring your edges.</p>`
        : `<p>The passage ahead is narrow, but not threatening. Justâ€¦ deliberate.</p>`;

    const mood =
      attitude === "welcoming"
        ? `<p>The lantern light reaches farther than it should, offering you an easier path.</p>`
        : attitude === "wary"
        ? `<p>Shadows gather closer to the baseboards, as if told not to look away from you.</p>`
        : `<p>The corridor holds its breath.</p>`;

    return `
      ${answerEcho}
      ${corridor}
      ${mood}
      <p>Chalk sigils line the stone in half-erased layersâ€”rewritten, reinforced, corrected.</p>
      <p class="rw-intro-dialog">â€œContainment path,â€ Mira says. â€œFor when something inside forgets its boundaries.â€</p>
    `;
  },
  choices: [
    {
      text: "Walk carefully and keep your pace steady. (Will DC 12)",
      to: "18",
      key: "p17_steady",
      check: {
        label: "Composure",
        stat: "will",
        dc: 12,
        successMsg: "Your body stays calm. The corridor does not tighten further.",
        failMsg: "Your breath catches. The sigils brightenâ€”alert, not attack.",
        deltaAttitudeSuccess: +1,
        deltaAttitudeFail: -1,
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Study the chalk marks for what changed. (Insight DC 13)",
      to: "18",
      key: "p17_study_chalk",
      check: {
        label: "Arcana Sense",
        stat: "insight",
        dc: 13,
        successMsg: "You recognize repair-workâ€”patching weak seams in old wards.",
        failMsg: "The patterns refuse to settle in your mind. The manor keeps its handwriting private.",
        deltaAttitudeSuccess: +1,
      },
    },
    {
      text: "Ask Mira what happened here.",
      to: "18",
      key: "p17_ask_happened",
      deltaAttitude: 0,
    },
  ],
},

"18": {
  title: "A Misstep (or Not)",
  image: "b1-p18.png",
  body: (S) => {
    const heat = getWardHeat();
    const attitude = getManorAttitudeLabel();

    const tension =
      heat >= 2
        ? `<p>The floor feels slightly unevenâ€”like the manor arranged the stones to test you.</p>`
        : `<p>The stones are worn, but stable. Still, you feel the corridor waiting for a mistake.</p>`;

    const mood =
      attitude === "wary"
        ? `<p>Miraâ€™s hand hovers near the wall, ready to steady something you canâ€™t see.</p>`
        : `<p>Mira watches your feet more than your face.</p>`;

    return `
      ${tension}
      ${mood}
      <p>Your boot catches the slightest rise in the stone.</p>
      <p>The corridor shiversâ€”attention snapping tight for a heartbeat.</p>
      <p class="rw-intro-dialog">â€œEasy,â€ Mira murmurs. â€œItâ€™s deciding what that meant.â€</p>
    `;
  },
  choices: [
    {
      text: "Recover smoothly, like it never happened. (Agility DC 12)",
      to: "19",
      key: "p18_recover_smooth",
      check: {
        label: "Balance",
        stat: "agility",
        dc: 12,
        successMsg: "You flow back into stride. The corridorâ€™s interest fades.",
        failMsg: "Your recovery turns into a stumble. The sigils flareâ€”recording.",
        deltaAttitudeSuccess: +1,
        deltaAttitudeFail: -1,
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Stop and acknowledge the ward aloudâ€”respectfully. (Presence DC 13)",
      to: "19",
      key: "p18_acknowledge",
      check: {
        label: "Etiquette",
        stat: "presence",
        dc: 13,
        successMsg: "The air relaxes. The manor prefers recognition over denial.",
        failMsg: "Your words land wrong. The corridor stays tense.",
        deltaAttitudeSuccess: +2,
        deltaAttitudeFail: -1,
      },
    },
    {
      text: "Clench your jaw and push forward.",
      to: "19",
      key: "p18_push_forward",
      deltaWardHeat: +1,
    },
  ],
},

"19": {
  title: "When the Manor Decides",
  image: "b1-p19.png",
  body: (S) => {
    const attitude = getManorAttitudeLabel();
    const heat = getWardHeat();
    const f = S.flags || {};

    const outcome =
      f.p18_recover_smooth_success
        ? `<p>The corridor releases youâ€”like a hand letting go.</p>`
        : f.p18_acknowledge_success
        ? `<p>The lantern flame lifts. Something in the stone seemsâ€¦ satisfied.</p>`
        : (f.p18_recover_smooth_fail || f.p18_acknowledge_fail)
        ? `<p>The corridor remains tight. Not hostileâ€”just watchful in a sharper way.</p>`
        : `<p>The corridor settles into stillness again.</p>`;

    const label =
      attitude === "welcoming"
        ? `<p class="rw-intro-dialog">â€œStill guest,â€ Mira says softly. â€œThatâ€™s good.â€</p>`
        : attitude === "wary"
        ? `<p class="rw-intro-dialog">â€œStill undecided,â€ Mira whispers. â€œThatâ€™s not as good.â€</p>`
        : `<p class="rw-intro-dialog">â€œIt hasnâ€™t filed you as threat,â€ Mira says. â€œYet.â€</p>`;

    const heatLine =
      heat >= 2
        ? `<p>You feel the manorâ€™s attention sliding ahead of you nowâ€”like itâ€™s preparing the next test.</p>`
        : `<p>The air tastes faintly of mineral stone and candle smoke.</p>`;

    return `
      ${outcome}
      ${label}
      ${heatLine}
      <p>The corridor opens to a spiral stair descending into shadow.</p>
    `;
  },
  choices: [
    {
      text: "Descend carefully, counting your steps. (Insight DC 12)",
      to: "20",
      key: "p19_count_steps",
      check: {
        label: "Pattern",
        stat: "insight",
        dc: 12,
        successMsg: "You feel where the ward-lines cross the stairwellâ€”like invisible seams.",
        failMsg: "Your count slips. The stairwellâ€™s rhythm changes just to catch you.",
        deltaAttitudeSuccess: +1,
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Descend with steady courage. (Will DC 12)",
      to: "20",
      key: "p19_descend_will",
      check: {
        label: "Resolve",
        stat: "will",
        dc: 12,
        successMsg: "Your breath stays even. The stairwell stays calm.",
        failMsg: "Cold creeps into your lungs. The manor notes your fear.",
        deltaAttitudeSuccess: +1,
        deltaAttitudeFail: -1,
        deltaWardHeatFail: +1,
      },
    },
    { text: "Ask Mira whatâ€™s below before moving.", to: "20", key: "p19_ask_below" },
  ],
},

"20": {
  title: "The Stair of Descent",
  image: "b1-p20.png",
  body: (S) => {
    const heat = getWardHeat();
    const attitude = getManorAttitudeLabel();

    const cold =
      heat >= 2
        ? `<p>The cold rising from below feels sharperâ€”clean, but insistent.</p>`
        : `<p>Cold rises from belowâ€”clean stone cold, old as buried rivers.</p>`;

    const mood =
      attitude === "welcoming"
        ? `<p>The lantern light steadies, as if offering you a safer descent.</p>`
        : attitude === "wary"
        ? `<p>The flame bends inward, as if trying to hide from whatâ€™s below.</p>`
        : `<p>The light holds neutral, neither warning nor guiding.</p>`;

    return `
      ${cold}
      ${mood}
      <p class="rw-intro-dialog">â€œThis isnâ€™t a dungeon,â€ Mira says. â€œItâ€™s where the manor keeps what it canâ€™t afford to forget.â€</p>
    `;
  },
  choices: [
    {
      text: "Keep one hand on the wall and feel for ward-lines. (Insight DC 13)",
      to: "21",
      key: "p20_feel_wardlines",
      check: {
        label: "Ward Sense",
        stat: "insight",
        dc: 13,
        successMsg: "You feel the wards like faint vibrationâ€”alive, layered, old.",
        failMsg: "The stone goes numb under your touch. The manor refuses to be read that way.",
        deltaAttitudeSuccess: +1,
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Ask Mira what the manor forgets. (Presence DC 12)",
      to: "21",
      key: "p20_ask_forgets",
      check: {
        label: "Gentle Questions",
        stat: "presence",
        dc: 12,
        successMsg: "Mira answersâ€”quietly. The manor seems to tolerate the truth.",
        failMsg: "Mira shuts it down with a look. â€œNot here.â€",
        deltaAttitudeSuccess: +1,
        deltaAttitudeFail: -1,
      },
    },
    { text: "Say nothing and keep going.", to: "21", key: "p20_silent" },
  ],
},

"21": {
  title: "The Archive Below",
  image: "b1-p21.png",
  body: (S) => {
    const attitude = getManorAttitudeLabel();
    const heat = getWardHeat();

    const room =
      heat >= 2
        ? `<p>The chamber below feels occupiedâ€”like something is already awake down here.</p>`
        : `<p>The chamber below is vast and stillâ€”shelving carved into the stone like rib bones.</p>`;

    const mood =
      attitude === "welcoming"
        ? `<p>The air is cool but not hostile. Like entering a library that has decided to tolerate you.</p>`
        : attitude === "wary"
        ? `<p>The air is cold and measuring. Like entering a room where you are already suspected.</p>`
        : `<p>The air is neutral, heavy with old silence.</p>`;

    return `
      ${room}
      ${mood}
      <p>Objects sit wrapped in cloth, sealed in glass, bound in runesâ€”none labeled.</p>
      <p class="rw-intro-dialog">â€œArchives,â€ Mira says. â€œNot records. Relics of decisions.â€</p>
    `;
  },
  choices: [
    {
      text: "Approach the nearest glass case carefully. (Agility DC 12)",
      to: "22",
      key: "p21_approach_case",
      check: {
        label: "Careful Steps",
        stat: "agility",
        dc: 12,
        successMsg: "You move without disturbing the ward-fog around the display.",
        failMsg: "A thin chime rings outâ€”quiet, but loud enough to be recorded.",
        deltaWardHeatFail: +1,
        deltaAttitudeFail: -1,
      },
    },
    {
      text: "Ask Mira what the cases hold. (Presence DC 11)",
      to: "22",
      key: "p21_ask_cases",
      check: {
        label: "Plain Ask",
        stat: "presence",
        dc: 11,
        successMsg: "Mira answers with one sentence. No more.",
        failMsg: "Miraâ€™s eyes flick to the shelves. â€œSome things donâ€™t like being named.â€",
      },
    },
    { text: "Scan the room for anything that reacts to you. (Insight DC 12)", to: "22", key: "p21_scan_react",
      check: {
        label: "Notice",
        stat: "insight",
        dc: 12,
        successMsg: "One shelf hums faintly when you look at itâ€”recognition, not threat.",
        failMsg: "Everything looks stillâ€¦ and you realize that means youâ€™re missing the real movement.",
        deltaWardHeatFail: +1,
      },
    },
  ],
},

"22": {
  title: "The Case That Watches Back",
  image: "b1-p22.png",
  body: (S) => {
    const heat = getWardHeat();
    const f = S.flags || {};

    const react =
      f.p21_scan_react_success
        ? `<p>You know exactly which shelf is listening. You can feel it like a fingertip on your spine.</p>`
        : `<p>Glass reflects your lantern light in soft, shifting shapes.</p>`;

    const tension =
      heat >= 2
        ? `<p>The air around the cases feels chargedâ€”like a storm held behind teeth.</p>`
        : `<p>The air is cool and stillâ€”too still for a place full of memory.</p>`;

    return `
      ${react}
      ${tension}
      <p>Inside one case rests a small object wrapped in dark cloth, bound with a single silver thread.</p>
      <p class="rw-intro-dialog">â€œDonâ€™t touch glass in the archive,â€ Mira says. â€œIt counts as asking.â€</p>
    `;
  },
  choices: [
    {
      text: "Ask permission aloud before getting closer. (Presence DC 13)",
      to: "23",
      key: "p22_ask_permission",
      check: {
        label: "Respect",
        stat: "presence",
        dc: 13,
        successMsg: "The pressure eases. The manor seems to accept the courtesy.",
        failMsg: "Silence. Heavy silence. The manor does not answerâ€”yet it hears you clearly.",
        deltaAttitudeSuccess: +2,
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Study the silver thread binding it. (Insight DC 13)",
      to: "23",
      key: "p22_study_thread",
      check: {
        label: "Wardwork",
        stat: "insight",
        dc: 13,
        successMsg: "Itâ€™s a sealing threadâ€”meant to contain a story that bites.",
        failMsg: "Your eyes sting. You look away too late.",
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Step back and choose a different shelf.",
      to: "23",
      key: "p22_step_back",
      deltaAttitude: 0,
    },
  ],
},

"23": {
  title: "The Archiveâ€™s Price",
  image: "b1-p23.png",
  body: (S) => {
    const heat = getWardHeat();
    const attitude = getManorAttitudeLabel();
    const f = S.flags || {};

    const line =
      f.p22_ask_permission_success
        ? `<p>The room loosens around youâ€”subtle, but undeniable.</p>`
        : f.p22_ask_permission_fail
        ? `<p>The room holds its breath. You realize that was an answer.</p>`
        : f.p22_study_thread_success
        ? `<p>The silver thread seems to pulse once, like a living vein.</p>`
        : `<p>The shelves remain quiet, waiting for what you do next.</p>`;

    const heatLine =
      heat >= 2
        ? `<p class="rw-intro-dialog">â€œWe should be quick,â€ Mira mutters. â€œThe wards are warm.â€</p>`
        : `<p class="rw-intro-dialog">â€œOnly take what you can carry,â€ Mira says. â€œEven if itâ€™s not in your hands.â€</p>`;

    const mood =
      attitude === "wary"
        ? `<p>The lantern flame flickers low, like it wants you to leave this place unchanged.</p>`
        : `<p>The lantern flame steadies, watching without judgment.</p>`;

    return `
      ${line}
      ${mood}
      ${heatLine}
      <p>You feel it then: the archive doesnâ€™t punish curiosityâ€¦ it charges for it.</p>
    `;
  },
  choices: [
    {
      text: "Pay attention to your bodyâ€”what changes as you look around? (Will DC 12)",
      to: "24",
      key: "p23_body_awareness",
      check: {
        label: "Grounding",
        stat: "will",
        dc: 12,
        successMsg: "You stay present. The archive canâ€™t hook as easily.",
        failMsg: "A memory rises uninvitedâ€”sharp, specific, not yours.",
        deltaWardHeatFail: +1,
        deltaAttitudeFail: -1,
      },
    },
    {
      text: "Ask Mira what the archive wants. (Insight DC 12)",
      to: "24",
      key: "p23_ask_wants",
      check: {
        label: "Interpretation",
        stat: "insight",
        dc: 12,
        successMsg: "You understand: it wants consistent truth, not bravery.",
        failMsg: "The meaning slips. The manor keeps its motives behind stone.",
        deltaAttitudeSuccess: +1,
      },
    },
    { text: "Back away and follow Mira out.", to: "24", key: "p23_follow_out" },
  ],
},

"24": {
  title: "A Shelf That Knows You",
  image: "b1-p24.png",
  body: (S) => {
    const f = S.flags || {};
    const heat = getWardHeat();

    const hook =
      f.p23_body_awareness_fail
        ? `<p>The Ñ‡ÑƒĞ¶ÌĞ´ memory clings like smoke. You canâ€™t tell where it came from.</p>`
        : `<p>The air tastes like old paper and stone dustâ€”memory made physical.</p>`;

    const charge =
      heat >= 2
        ? `<p>One shelf hums before you even look at it.</p>`
        : `<p>When your gaze drifts, one shelf answers with a faint vibration.</p>`;

    return `
      ${hook}
      ${charge}
      <p>Not invitation. Not warning.</p>
      <p>Recognition.</p>
      <p class="rw-intro-dialog">â€œDonâ€™t take it personally,â€ Mira says softly. â€œThe manor recognizes patterns.â€</p>
    `;
  },
  choices: [
    {
      text: "Approach the shelf that reacted. (Will DC 13)",
      to: "25",
      key: "p24_approach_reactive",
      check: {
        label: "Steady Nerves",
        stat: "will",
        dc: 13,
        successMsg: "You hold your ground. The shelfâ€™s hum becomesâ€¦ less sharp.",
        failMsg: "Your chest tightens. The hum deepensâ€”like a hook setting.",
        deltaWardHeatFail: +1,
        deltaAttitudeFail: -1,
      },
    },
    {
      text: "Refuse the pull and choose another shelf. (Might DC 12)",
      to: "25",
      key: "p24_refuse_pull",
      check: {
        label: "Stubbornness",
        stat: "might",
        dc: 12,
        successMsg: "You break the thread of attention. The manor notices the boundary.",
        failMsg: "The pull follows anywayâ€”subtle, persistent.",
        deltaWardHeatFail: +1,
      },
    },
    { text: "Ask Mira why that shelf reacted to you.", to: "25", key: "p24_ask_why" },
  ],
},

"25": {
  title: "A Memory Not Yours",
  image: "b1-p25.png",
  body: (S) => {
    const f = S.flags || {};
    const heat = getWardHeat();
    const attitude = getManorAttitudeLabel();

    const memory =
      f.p24_approach_reactive_success
        ? `<p>A flicker crosses your mindâ€”lantern light in a different hand. A voice you donâ€™t recognize saying your name like a warning.</p>`
        : f.p24_approach_reactive_fail
        ? `<p>The memory hits like a sudden bruise. A door slamming. A child crying. Not your lifeâ€”yet it lands in you.</p>`
        : `<p>Something brushes your mind, like fingertips testing a page edge.</p>`;

    const heatLine =
      heat >= 2
        ? `<p class="rw-intro-dialog">â€œEnough,â€ Mira snaps under her breath. â€œNot that one.â€</p>`
        : `<p class="rw-intro-dialog">â€œIf it offers you something,â€ Mira warns, â€œmake sure you know what youâ€™re paying.â€</p>`;

    const mood =
      attitude === "welcoming"
        ? `<p>The manorâ€™s presence feels curious, not cruel.</p>`
        : attitude === "wary"
        ? `<p>The manorâ€™s presence feels clinicalâ€”like a blade deciding where to cut.</p>`
        : `<p>The manorâ€™s presence feels neutral, like stone listening to rain.</p>`;

    return `
      ${memory}
      ${mood}
      ${heatLine}
      <p>You realize the archive isnâ€™t only storing history.</p>
      <p>Itâ€™s storing <em>experiences</em>.</p>
    `;
  },
  choices: [
    {
      text: "Push the Ñ‡ÑƒĞ¶ÌĞ´ memory out. (Will DC 13)",
      to: "26",
      key: "p25_push_out",
      check: {
        label: "Mental Guard",
        stat: "will",
        dc: 13,
        successMsg: "You regain ownership of your thoughts. The shelfâ€™s hum fades.",
        failMsg: "It clings. Not fully. But enough.",
        deltaWardHeatFail: +1,
        deltaAttitudeFail: -1,
      },
    },
    {
      text: "Look for Miraâ€™s cues and follow her lead. (Insight DC 12)",
      to: "26",
      key: "p25_follow_cues",
      check: {
        label: "Read Mira",
        stat: "insight",
        dc: 12,
        successMsg: "You move exactly when she moves. The manor approves coordination.",
        failMsg: "Youâ€™re half a heartbeat late. The wards notice the lag.",
        deltaAttitudeSuccess: +1,
        deltaWardHeatFail: +1,
      },
    },
    { text: "Ask Mira what that memory was.", to: "26", key: "p25_ask_memory" },
  ],
},

"26": {
  title: "The Manor Answers First",
  image: "b1-p26.png",
  body: (S) => {
    const heat = getWardHeat();
    const attitude = getManorAttitudeLabel();

    const first =
      heat >= 2
        ? `<p>You feel it before anything happensâ€”pressure shifting in the stone, like the manor preparing a response.</p>`
        : `<p>You notice it only after: the lantern flame leaning, the air changing direction.</p>`;

    const mood =
      attitude === "welcoming"
        ? `<p>The change feels like guidanceâ€”subtle, careful.</p>`
        : attitude === "wary"
        ? `<p>The change feels like containmentâ€”soft, but unmistakable.</p>`
        : `<p>The change feels observational, like being studied through glass.</p>`;

    return `
      ${first}
      ${mood}
      <p class="rw-intro-dialog">â€œThatâ€™s new,â€ Mira whispers. â€œIt usually waits for a choice.â€</p>
      <p>The archive has decided youâ€™re worth reacting to.</p>
    `;
  },
  choices: [
    {
      text: "Hold still and let it pass over you. (Will DC 12)",
      to: "27",
      key: "p26_hold_still",
      check: {
        label: "Stillness",
        stat: "will",
        dc: 12,
        successMsg: "The pressure passes without catching. The manor notes your control.",
        failMsg: "You flinch. The manor records the reflex.",
        deltaAttitudeSuccess: +1,
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Speak a calm boundary aloud: â€œNot mine.â€ (Presence DC 13)",
      to: "27",
      key: "p26_boundary",
      check: {
        label: "Boundary",
        stat: "presence",
        dc: 13,
        successMsg: "The air loosens. The manor accepts the boundary as valid.",
        failMsg: "Your voice shakes. The boundary lands as fear instead of fact.",
        deltaAttitudeFail: -1,
        deltaWardHeatFail: +1,
      },
    },
    { text: "Take Miraâ€™s arm and follow her out now.", to: "27", key: "p26_exit_now", deltaWardHeat: -1 },
  ],
},

"27": {
  title: "The Exit Path",
  image: "b1-p27.png",
  body: (S) => {
    const heat = getWardHeat();
    const f = S.flags || {};

    const after =
      f.p26_exit_now
        ? `<p>Mira doesnâ€™t argue. That alone tells you enough.</p>`
        : `<p>Mira angles her body subtlyâ€”guiding you away without making it obvious to the room.</p>`;

    const tension =
      heat >= 2
        ? `<p>The archiveâ€™s attention follows like a slow turn of a head.</p>`
        : `<p>The shelves quiet again, as if satisfied with what they learned.</p>`;

    return `
      ${after}
      ${tension}
      <p class="rw-intro-dialog">â€œWeâ€™re leaving,â€ Mira saysâ€”not to you, but to the manor.</p>
      <p>The stairwell waits like an answer you havenâ€™t asked yet.</p>
    `;
  },
  choices: [
    {
      text: "Descend quickly before the archive changes its mind. (Agility DC 12)",
      to: "28",
      key: "p27_descend_fast",
      check: {
        label: "Speed",
        stat: "agility",
        dc: 12,
        successMsg: "You move cleanly. The pressure behind you doesnâ€™t catch.",
        failMsg: "Your foot slips. The archive flaresâ€”one last note taken.",
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Leave slowly, respectfully. (Presence DC 12)",
      to: "28",
      key: "p27_leave_respect",
      check: {
        label: "Ritual Exit",
        stat: "presence",
        dc: 12,
        successMsg: "The manor accepts your exit as proper. The air stays calm.",
        failMsg: "Your respect lands uncertain. The manor remains watchful.",
        deltaAttitudeFail: -1,
      },
    },
    { text: "Ask Mira if the archive will follow you.", to: "28", key: "p27_ask_follow" },
  ],
},

"28": {
  title: "The Hall Above, Changed",
  image: "b1-p28.png",
  body: (S) => {
    const heat = getWardHeat();
    const attitude = getManorAttitudeLabel();

    const change =
      heat >= 2
        ? `<p>The corridor feels smaller than beforeâ€”like the manor adjusted it while you were gone.</p>`
        : `<p>The corridor feels the sameâ€¦ until you realize the portraits are different.</p>`;

    const mood =
      attitude === "welcoming"
        ? `<p>The lanterns brighten as you step in. A small, unmistakable mercy.</p>`
        : attitude === "wary"
        ? `<p>The lanterns stay low. The shadows feel organized.</p>`
        : `<p>The light remains neutral, but attentive.</p>`;

    return `
      ${change}
      ${mood}
      <p class="rw-intro-dialog">â€œIt updates,â€ Mira says quietly. â€œIt always updates.â€</p>
      <p>You realize the manor has already filed today under a category.</p>
    `;
  },
  choices: [
    {
      text: "Try to sense what category it filed you under. (Insight DC 13)",
      to: "29",
      key: "p28_sense_category",
      check: {
        label: "Sense",
        stat: "insight",
        dc: 13,
        successMsg: "You feel it: not threat. Not friend. Something likeâ€¦ 'possible.'",
        failMsg: "Your mind skids off the meaning. The manor keeps its labels private.",
        deltaAttitudeSuccess: +1,
      },
    },
    {
      text: "Ask Mira what she thinks the manor decided. (Presence DC 12)",
      to: "29",
      key: "p28_ask_mira_decision",
      check: {
        label: "Trust",
        stat: "presence",
        dc: 12,
        successMsg: "Mira answers honestly. That honesty seems to help.",
        failMsg: "Mira hesitates. The manor listens harder when you ask that.",
        deltaWardHeatFail: +1,
      },
    },
    { text: "Keep walking. Donâ€™t give it more data.", to: "29", key: "p28_keep_walking", deltaWardHeat: 0 },
  ],
},

"29": {
  title: "The Fourth Ward: The Mirror-Lintels",
  image: "b1-p29.png",
  body: (S) => {
    const heat = getWardHeat();
    const attitude = getManorAttitudeLabel();

    const ward =
      heat >= 2
        ? `<p>A pair of mirror-like lintels waits ahead. Their surfaces ripple faintly as you approach.</p>`
        : `<p>Two pale stone lintels flank the doorway, each polished to a faint reflective sheen.</p>`;

    const mood =
      attitude === "wary"
        ? `<p class="rw-intro-dialog">â€œThis one catches self-deception,â€ Mira warns. â€œDonâ€™t argue with what it shows.â€</p>`
        : `<p class="rw-intro-dialog">â€œMirror-lintels,â€ Mira says. â€œThey reflect what youâ€™re trying not to admit.â€</p>`;

    return `
      ${ward}
      ${mood}
      <p>Your reflection is not quite aligned with your movements.</p>
      <p>It lagsâ€”like itâ€™s choosing what to show.</p>
    `;
  },
  choices: [
    {
      text: "Cross while holding a single honest thought. (Will DC 13)",
      to: "30",
      key: "p29_hold_truth",
      check: {
        label: "Inner Truth",
        stat: "will",
        dc: 13,
        successMsg: "The reflection aligns. The lintels let you pass without friction.",
        failMsg: "The reflection smiles when you donâ€™t. The lintels tightenâ€”recording denial.",
        deltaAttitudeFail: -1,
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Meet your reflectionâ€™s eyes and do not look away. (Presence DC 13)",
      to: "30",
      key: "p29_meet_eyes",
      check: {
        label: "Self-Possession",
        stat: "presence",
        dc: 13,
        successMsg: "The reflection stills. The manor respects ownership.",
        failMsg: "Your gaze breaks. The reflection moves on its own for a heartbeat.",
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Ask Mira to go first so you can watch what happens.",
      to: "30",
      key: "p29_watch_mira",
      deltaAttitude: 0,
    },
  ],
},

"30": {
  title: "Filed Under: Possible",
  image: "b1-p30.png",
  body: (S) => {
    const heat = getWardHeat();
    const attitude = getManorAttitudeLabel();
    const f = S.flags || {};

    const passage =
      f.p29_hold_truth_success || f.p29_meet_eyes_success
        ? `<p>You pass through with minimal resistance. The air behind you seals like a page turning.</p>`
        : f.p29_hold_truth_fail || f.p29_meet_eyes_fail
        ? `<p>You pass through, but the lintels keep a thin pressure on your shouldersâ€”like a bookmark pressed into place.</p>`
        : `<p>Mira passes first. The lintels stay neutral, then turn their attention to you.</p>`;

    const tag =
      attitude === "welcoming"
        ? `<p class="rw-intro-dialog">â€œItâ€™sâ€¦ almost kind,â€ Mira says softly, as if surprised by the word.</p>`
        : attitude === "wary"
        ? `<p class="rw-intro-dialog">â€œIt hasnâ€™t rejected you,â€ Mira says. â€œThatâ€™s not approval. But itâ€™s not a sentence.â€</p>`
        : `<p class="rw-intro-dialog">â€œWatchful,â€ Mira says. â€œStill watchful.â€</p>`;

    const heatLine =
      heat >= 2
        ? `<p>You feel it: the manor now reacts before you act. Itâ€™s started anticipating you.</p>`
        : `<p>You feel it: the manor is beginning to treat you as a variable worth tracking.</p>`;

    return `
      ${passage}
      ${tag}
      ${heatLine}
      <p>The next corridor is darker, quieterâ€”like the manor is saving something for later.</p>
      <p class="rw-intro-dialog">â€œTomorrow,â€ Mira murmurs, â€œitâ€™ll test you differently.â€</p>
    `;
  },
  choices: [
    { text: "Continue (Book I Â· Part II begins).", to: "31", key: "p30_continue" },
    { text: "Open Inventory.", to: "30", key: "p30_inventory_hint" },
  ],
},

// ============================
// BOOK I Â· Pages 31â€“45 (mechanics + choices)
// ============================

"31": {
  title: "Part II Â· The Manorâ€™s Inner Rules",
  image: "b1-p31.png",
  body: (S) => {
    const attitude = getManorAttitudeLabel();
    const heat = getWardHeat();

    const mood =
      attitude === "welcoming"
        ? `<p>The corridor ahead feels less like a test and more like a guided passage.</p>`
        : attitude === "wary"
        ? `<p>The corridor ahead feels like a hallway in a courthouse: quiet, controlled, unforgiving.</p>`
        : `<p>The corridor ahead is neutralâ€”listening for what youâ€™ll become.</p>`;

    const heatLine =
      heat >= 2
        ? `<p>The air has a faint static bite to it, as if the wards are already awake.</p>`
        : `<p>The lantern flame holds steady, as if waiting for permission to flicker.</p>`;

    return `
      <p>The stone underfoot changesâ€”subtle at firstâ€”then unmistakable.</p>
      <p>Less worn. Less forgiving.</p>
      ${mood}
      ${heatLine}
      <p class="rw-intro-dialog">â€œThis is where the manor stops pretending itâ€™s a building,â€ Mira murmurs. â€œAnd starts behaving like a rule-set.â€</p>
    `;
  },
  choices: [
    {
      text: "Ask what rule youâ€™re most likely to break. (Insight DC 12)",
      to: "32",
      key: "p31_ask_rule",
      check: {
        label: "Interpretation",
        stat: "insight",
        dc: 12,
        successMsg: "Mira answers quicklyâ€”like sheâ€™s been waiting for you to ask the right thing.",
        failMsg: "Miraâ€™s gaze sharpens. â€œNot that question. Not yet.â€",
        deltaAttitudeSuccess: +1,
        deltaAttitudeFail: -1,
      },
    },
    {
      text: "Say nothing. Let the manor gather data from your silence.",
      to: "32",
      key: "p31_silent",
      deltaAttitude: 0,
    },
  ],
},

"32": {
  title: "Fourth Ward: The Threshold-Count",
  image: "b1-p32.png",
  body: (S) => {
    const heat = getWardHeat();
    const attitude = getManorAttitudeLabel();
    const f = S.flags || {};

    const miraLine =
      f.p31_ask_rule_success
        ? `<p class="rw-intro-dialog">â€œMost people try to outsmart it,â€ Mira said. â€œThe manor hates theatrics.â€</p>`
        : f.p31_ask_rule_fail
        ? `<p class="rw-intro-dialog">â€œWalk,â€ Mira said quietly. â€œWe donâ€™t feed it extra words right now.â€</p>`
        : `<p class="rw-intro-dialog">â€œThis ward counts thresholds,â€ Mira whispers. â€œIt prefers consistency.â€</p>`;

    const ward =
      heat >= 2
        ? `<p>A faint set of tally-marks glimmers along the lintelâ€”like scratches in moonlight.</p>`
        : `<p>The lintel bears shallow marksâ€”too clean to be accidental.</p>`;

    const mood =
      attitude === "wary"
        ? `<p>The air tightens as if waiting for you to slip.</p>`
        : `<p>The air stays neutral, listening for intent.</p>`;

    return `
      ${ward}
      ${miraLine}
      ${mood}
      <p>Something about the doorway makes your steps feel louder than they should.</p>
    `;
  },
  choices: [
    {
      text: "Cross with steady, repeated cadence. (Will DC 12)",
      to: "33",
      key: "p32_steady_cadence",
      check: {
        label: "Composure",
        stat: "will",
        dc: 12,
        successMsg: "The lintelâ€™s pressure fades. You feel countedâ€”then accepted.",
        failMsg: "Your rhythm breaks. The tally-marks brightenâ€”recording inconsistency.",
        deltaAttitudeSuccess: +1,
        deltaAttitudeFail: -1,
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Try to â€œskipâ€ the count by stepping oddly. (Agility DC 13)",
      to: "33",
      key: "p32_skip_count",
      check: {
        label: "Trick Step",
        stat: "agility",
        dc: 13,
        successMsg: "You slip through the seam between beats. The manor notes the skillâ€”warily.",
        failMsg: "The lintel snaps tight for a heartbeat. It counts you twice on purpose.",
        deltaAttitudeFail: -1,
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Ask permission before crossing. (Presence DC 13)",
      to: "33",
      key: "p32_ask_permission",
      check: {
        label: "Ritual Courtesy",
        stat: "presence",
        dc: 13,
        successMsg: "The doorway softens. Courtesy lands well here.",
        failMsg: "No answer. The silence feels like a warning, but the path remains open.",
        deltaAttitudeSuccess: +2,
      },
    },
  ],
},

"33": {
  title: "The Corridor of Soft Footfalls",
  image: "b1-p33.png",
  body: (S) => {
    const heat = getWardHeat();
    const attitude = getManorAttitudeLabel();
    const f = S.flags || {};

    const echo =
      f.p32_steady_cadence_success
        ? `<p>Your feet feel lighter after the lintelâ€”like the manor stopped pressing its thumb into you.</p>`
        : f.p32_skip_count_success
        ? `<p>The corridor feels alert nowâ€”less hostile, moreâ€¦ interested in your tactics.</p>`
        : (f.p32_steady_cadence_fail || f.p32_skip_count_fail)
        ? `<p>Your shoulders carry a faint pressureâ€”like the manor stamped a note into your file.</p>`
        : `<p>The corridor stretches ahead, quiet as a held breath.</p>`;

    const ward =
      heat >= 2
        ? `<p>The stone here seems to absorb sound. You canâ€™t tell if thatâ€™s kindness or control.</p>`
        : `<p>The stone here muffles your steps, as if the manor is reducing noise on purpose.</p>`;

    const mood =
      attitude === "welcoming"
        ? `<p>The lanterns brighten a fraction, offering clearer edges to the hall.</p>`
        : attitude === "wary"
        ? `<p>The lanterns stay low. Shadows hold their places like disciplined soldiers.</p>`
        : `<p>The light stays neutral, but attentive.</p>`;

    return `
      ${echo}
      ${ward}
      ${mood}
      <p class="rw-intro-dialog">â€œThis corridor hears lies,â€ Mira says. â€œNot wordsâ€”<em>posture</em>.â€</p>
    `;
  },
  choices: [
    {
      text: "Walk honestlyâ€”no performance. (Presence DC 12)",
      to: "34",
      key: "p33_walk_honest",
      check: {
        label: "Authenticity",
        stat: "presence",
        dc: 12,
        successMsg: "The corridor loosens. The manor prefers unadorned truth.",
        failMsg: "You try too hard. The corridor feels colderâ€”like it hates being impressed.",
        deltaAttitudeSuccess: +1,
        deltaAttitudeFail: -1,
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Focus inward and keep your fear from spiking. (Will DC 13)",
      to: "34",
      key: "p33_keep_calm",
      check: {
        label: "Fear Control",
        stat: "will",
        dc: 13,
        successMsg: "Your breath stays even. The corridor stops leaning into you.",
        failMsg: "A flicker of panic rises. The stone drinks it like fuel.",
        deltaWardHeatFail: +1,
        deltaAttitudeFail: -1,
      },
    },
    { text: "Ask Mira what it does when it â€˜hearsâ€™ a lie.", to: "34", key: "p33_ask_consequence" },
  ],
},

"34": {
  title: "The First Door With a Handle",
  image: "b1-p34.png",
  body: (S) => {
    const heat = getWardHeat();
    const attitude = getManorAttitudeLabel();

    const door =
      heat >= 2
        ? `<p>The door handle looks ordinaryâ€”until you notice a faint rune-ring around its base.</p>`
        : `<p>The door has a handle. A real one. Almost mundane.</p>`;

    const mood =
      attitude === "welcoming"
        ? `<p>The handle feels cool, not hostileâ€”like a test offered gently.</p>`
        : attitude === "wary"
        ? `<p>The handle feels cold in a way that suggests consequence.</p>`
        : `<p>The handle feels neutralâ€”waiting for your intent.</p>`;

    return `
      ${door}
      ${mood}
      <p class="rw-intro-dialog">â€œDonâ€™t pull,â€ Mira warns. â€œNot yet.â€</p>
      <p>You realize this is the first door that expects you to participate.</p>
    `;
  },
  choices: [
    {
      text: "Study the rune-ring for meaning. (Insight DC 12)",
      to: "35",
      key: "p34_study_ring",
      check: {
        label: "Reading Wards",
        stat: "insight",
        dc: 12,
        successMsg: "You see it: the handle measures intentâ€”escape, entry, curiosity.",
        failMsg: "The ring blurs like oil on water. The manor wonâ€™t let you read it cleanly.",
        deltaAttitudeSuccess: +1,
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Place your palm near the handle without touching. (Will DC 12)",
      to: "35",
      key: "p34_palm_near",
      check: {
        label: "Restraint",
        stat: "will",
        dc: 12,
        successMsg: "You hold still. The ringâ€™s pressure fadesâ€”approval of control.",
        failMsg: "Your fingers twitch toward it. The ring tightensâ€”recording impulse.",
        deltaWardHeatFail: +1,
      },
    },
    { text: "Ask Mira whatâ€™s behind this door.", to: "35", key: "p34_ask_behind" },
  ],
},

"35": {
  title: "The Door That Measures Want",
  image: "b1-p35.png",
  body: (S) => {
    const heat = getWardHeat();
    const f = S.flags || {};

    const read =
      f.p34_study_ring_success
        ? `<p>You can almost <em>feel</em> the door sorting intentionsâ€”like cards being shuffled.</p>`
        : f.p34_study_ring_fail
        ? `<p>The door remains unreadable, but you feel it reading you anyway.</p>`
        : `<p>The rune-ring around the handle hums softly, like a held note.</p>`;

    const tension =
      heat >= 2
        ? `<p>The air tastes metallic for a moment, like the manor is charging the space.</p>`
        : `<p>The lantern flame steadies, waiting for your choice.</p>`;

    return `
      ${read}
      ${tension}
      <p class="rw-intro-dialog">â€œIf you touch it wanting to leave,â€ Mira murmurs, â€œit wonâ€™t open the same way.â€</p>
      <p class="rw-intro-dialog">â€œTouch it wanting to understandâ€¦ and it might let you in.â€</p>
    `;
  },
  choices: [
    {
      text: "Touch the handle with curiosity, not urgency. (Presence DC 13)",
      to: "36",
      key: "p35_touch_curiosity",
      check: {
        label: "Intent",
        stat: "presence",
        dc: 13,
        successMsg: "The rune-ring warms. The latch loosens like a sigh.",
        failMsg: "Your pulse betrays you. The ring tightensâ€”measuring need as threat.",
        deltaAttitudeSuccess: +2,
        deltaAttitudeFail: -1,
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Refuse to touch. Ask Mira to open it. (Insight DC 12)",
      to: "36",
      key: "p35_ask_mira_open",
      check: {
        label: "Delegation",
        stat: "insight",
        dc: 12,
        successMsg: "You recognize a safe move: let the ward-tender lead.",
        failMsg: "Miraâ€™s look says: youâ€™re still responsible for your own thresholds here.",
        deltaAttitudeFail: -1,
      },
    },
    { text: "Step back and breathe first.", to: "36", key: "p35_step_back", deltaWardHeat: -1 },
  ],
},

"36": {
  title: "A Room That Isnâ€™t a Room",
  image: "b1-p36.png",
  body: (S) => {
    const heat = getWardHeat();
    const attitude = getManorAttitudeLabel();
    const f = S.flags || {};

    const entry =
      f.p35_touch_curiosity_success
        ? `<p>The door opens like it recognizes the shape of your question.</p>`
        : f.p35_touch_curiosity_fail
        ? `<p>The door opens, but reluctantlyâ€”like itâ€™s keeping one hand on the chain.</p>`
        : `<p>Mira opens the door with a single careful movement, as if speaking a quiet password.</p>`;

    const space =
      heat >= 2
        ? `<p>Inside is a dim chamber that feels too large for the manorâ€™s footprintâ€”space folding wrong.</p>`
        : `<p>Inside is a dim chamber that feelsâ€¦ misaligned, like it was added later by something clever.</p>`;

    const mood =
      attitude === "wary"
        ? `<p>The air presses against your skinâ€”containment disguised as calm.</p>`
        : `<p>The air is cool and still, like a paused thought.</p>`;

    return `
      ${entry}
      ${space}
      ${mood}
      <p class="rw-intro-dialog">â€œAnchor room,â€ Mira says. â€œThe manor uses these to keep itselfâ€¦ stable.â€</p>
    `;
  },
  choices: [
    {
      text: "Look for the roomâ€™s anchor point. (Insight DC 13)",
      to: "37",
      key: "p36_find_anchor",
      check: {
        label: "Locate Anchor",
        stat: "insight",
        dc: 13,
        successMsg: "You spot it: a small sigil in the floor that hums under your attention.",
        failMsg: "The geometry refuses to settle. You feel briefly dizzyâ€”like the room shifted behind your eyes.",
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Ground yourself and resist the wrongness. (Will DC 12)",
      to: "37",
      key: "p36_ground",
      check: {
        label: "Grounding",
        stat: "will",
        dc: 12,
        successMsg: "Your breath steadies. The room stops leaning into you.",
        failMsg: "Your balance wavers. The room notes itâ€”quietly.",
        deltaWardHeatFail: +1,
      },
    },
    { text: "Ask Mira why the manor needs stability.", to: "37", key: "p36_ask_stable" },
  ],
},

"37": {
  title: "The Anchor-Sigil",
  image: "b1-p37.png",
  body: (S) => {
    const heat = getWardHeat();
    const f = S.flags || {};

    const anchor =
      f.p36_find_anchor_success
        ? `<p>The anchor-sigil sits like a nail pinning the room to reality.</p>`
        : `<p>You feel there is an anchor here even if you canâ€™t see itâ€”like a weight in water.</p>`;

    const warn =
      heat >= 2
        ? `<p class="rw-intro-dialog">â€œDonâ€™t step on it,â€ Mira warns quickly. â€œNot unless you want to be counted as part of the structure.â€</p>`
        : `<p class="rw-intro-dialog">â€œRespect it,â€ Mira says. â€œThese sigils keep the manor fromâ€¦ drifting.â€</p>`;

    return `
      ${anchor}
      ${warn}
      <p>The room feels like itâ€™s waiting to see whether you treat the anchor like a toolâ€¦ or a boundary.</p>
    `;
  },
  choices: [
    {
      text: "Step around the sigil carefully. (Agility DC 12)",
      to: "38",
      key: "p37_step_around",
      check: {
        label: "Careful Movement",
        stat: "agility",
        dc: 12,
        successMsg: "You move with respect. The room stays quiet.",
        failMsg: "Your heel brushes the line. The sigil humsâ€”recording contact.",
        deltaWardHeatFail: +1,
        deltaAttitudeFail: -1,
      },
    },
    {
      text: "Ask the room (not Mira) to remain stable. (Presence DC 13)",
      to: "38",
      key: "p37_ask_room",
      check: {
        label: "Address the House",
        stat: "presence",
        dc: 13,
        successMsg: "The air relaxes slightly. The manor recognizes the address.",
        failMsg: "The request lands flat. The manor does not reward uncertain ritual.",
        deltaAttitudeSuccess: +2,
        deltaAttitudeFail: -1,
      },
    },
    { text: "Study the sigilâ€™s shape for family resemblance. (Insight DC 12)", to: "38", key: "p37_study_shape",
      check: {
        label: "Pattern",
        stat: "insight",
        dc: 12,
        successMsg: "You recognize a familiar motifâ€”echoes of the wards youâ€™ve already passed.",
        failMsg: "The lines seem to rearrange under scrutiny.",
        deltaAttitudeSuccess: +1,
      },
    },
  ],
},

"38": {
  title: "The Manorâ€™s Quiet Hunger",
  image: "b1-p38.png",
  body: (S) => {
    const heat = getWardHeat();
    const attitude = getManorAttitudeLabel();

    const hunger =
      heat >= 2
        ? `<p>You feel it clearly here: the manor gathers attention like fuel.</p>`
        : `<p>You sense it faintly: the manor prefers engagement, not avoidance.</p>`;

    const mood =
      attitude === "welcoming"
        ? `<p>The sensation feels like curiosityâ€”sharp but not cruel.</p>`
        : attitude === "wary"
        ? `<p>The sensation feels like appetiteâ€”clinical, measuring, detached.</p>`
        : `<p>The sensation feels like observationâ€”calm but constant.</p>`;

    return `
      ${hunger}
      ${mood}
      <p class="rw-intro-dialog">â€œAnchor rooms are safe,â€ Mira says. â€œUntil you try to use them like leverage.â€</p>
      <p>You realize the manor is not only defending itself. Itâ€™sâ€¦ learning.</p>
    `;
  },
  choices: [
    {
      text: "Offer a single honest sentence to the manor. (Presence DC 12)",
      to: "39",
      key: "p38_offer_sentence",
      check: {
        label: "Honesty",
        stat: "presence",
        dc: 12,
        successMsg: "The air warms, barely. The manor accepts the offering.",
        failMsg: "Your sentence is true but guarded. The manor prefers clean truth.",
        deltaAttitudeSuccess: +2,
        deltaAttitudeFail: -1,
      },
    },
    {
      text: "Refuse to offer anything. Hold your boundaries. (Will DC 13)",
      to: "39",
      key: "p38_hold_boundary",
      check: {
        label: "Boundary",
        stat: "will",
        dc: 13,
        successMsg: "The pressure eases. The manor notes your boundary as stable.",
        failMsg: "The pressure persists. The manor records resistance as data.",
        deltaWardHeatFail: +1,
      },
    },
    { text: "Ask Mira what the manor learns from you.", to: "39", key: "p38_ask_learns" },
  ],
},

"39": {
  title: "A Gift: The Journal",
  image: "b1-p39.png",
  body: (S) => {
    const heat = getWardHeat();
    const attitude = getManorAttitudeLabel();

    // --- GUARANTEED JOURNAL GRANT (runs once) ---
    if (!S.flags?.p39_journal_granted) {
      S.flags = S.flags || {};
      S.flags.p39_journal_granted = true;

      // Add journal entry
      if (typeof window.rwAddJournalEntry === "function") {
        window.rwAddJournalEntry(
          "The manor placed a journal for me as if it had been waiting. Mira said itâ€™s for what I canâ€™t carry.",
          { source: "system", location: "Anchor Room" }
        );
      }

      // Add quest item to inventory (id-safe)
      if (Array.isArray(window.rwInventory)) {
        const hasJournal = window.rwInventory.some(
          (i) => i && i.id === "ravenwood_journal"
        );
        if (!hasJournal) {
          window.rwInventory.push({
            id: "ravenwood_journal",
            name: "Ravenwood Journal",
            icon: "item-journal.png",
            quest: true,
          });

          if (typeof window.syncInventoryToSupabase === "function") {
            window.syncInventoryToSupabase(window.rwInventory);
          }
        }
      }
    }

    // --- NARRATIVE TONE ---
    const itemTone =
      attitude === "welcoming"
        ? `<p>The object feels like a gift.</p>`
        : attitude === "wary"
        ? `<p>The object feels like a leash disguised as courtesy.</p>`
        : `<p>The object feels like a tool left where you would notice it.</p>`;

    const heatLine =
      heat >= 2
        ? `<p>The air around it hums faintly, as if the manor wants the moment recorded.</p>`
        : `<p>It sits quietly, already accounted for.</p>`;

    return `
      <p>You blink and realize something has changed.</p>
      ${itemTone}
      ${heatLine}
      <p>A dark leather journal rests on a stone tableâ€”no dust, no age.</p>
      <p class="rw-intro-dialog">
        Miraâ€™s voice lowers. â€œIt does that sometimes. It gives people a place to put what they canâ€™t carry.â€
      </p>
    `;
  },
  choices: [
    {
      text: "Take the journal.",
      to: "40",
      key: "p39_take_journal",
      deltaAttitude: +1,
    },
    {
      text: "Leave it where it isâ€”for now.",
      to: "40",
      key: "p39_leave_journal",
      deltaWardHeat: +1,
    },
    {
      text: "Ask Mira if the journal ever writes back. (Insight DC 12)",
      to: "40",
      key: "p39_writes_back",
      check: {
        stat: "insight",
        dc: 12,
        successMsg: "Mira answers with a look: yes. Sometimes. Not safely.",
        failMsg: "Mira avoids the answer. That tells you enough.",
        deltaAttitudeSuccess: +1,
      },
    },
  ],
},

"40": {
  title: "Leaving the Anchor Room",
  image: "b1-p40.png",
  body: (S) => {
    const heat = getWardHeat();
    const f = S.flags || {};

    const journal =
      f.p39_take_journal
        ? `<p>The journal is warm against your palm, like itâ€™s already aware of your grip.</p>`
        : `<p>You leave the table behind without touching what the manor offered.</p>`;

    const exit =
      heat >= 2
        ? `<p>The doorway feels narrower on the way outâ€”like the room is reluctant to release you.</p>`
        : `<p>The doorway releases you without fuss.</p>`;

    return `
      ${journal}
      ${exit}
      <p class="rw-intro-dialog">â€œDonâ€™t read too much into gifts,â€ Mira says. â€œThe manor doesnâ€™t gift. It <em>places</em>.â€</p>
      <p>The corridor beyond feels differentâ€”like the manor updated its expectations again.</p>
    `;
  },
  choices: [
    {
      text: "Ask Mira what the manor expects now. (Presence DC 12)",
      to: "41",
      key: "p40_expect_now",
      check: {
        label: "Ask",
        stat: "presence",
        dc: 12,
        successMsg: "Mira answers carefully. The manor seems to tolerate honest questions.",
        failMsg: "Miraâ€™s eyes flick to the walls. â€œNot while itâ€™s listening that closely.â€",
        deltaAttitudeSuccess: +1,
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Stay quiet and watch for the next wardâ€™s shape. (Insight DC 12)",
      to: "41",
      key: "p40_watch_next",
      check: {
        label: "Observe",
        stat: "insight",
        dc: 12,
        successMsg: "You notice it early: a thin shimmer in the air where the next ward begins.",
        failMsg: "You miss the seam until youâ€™re already inside it.",
        deltaWardHeatFail: +1,
      },
    },
    { text: "Keep walking. Donâ€™t invite extra tests.", to: "41", key: "p40_keep_walking", deltaWardHeat: 0 },
  ],
},

"41": {
  title: "Fifth Ward: The Oath-Air",
  image: "b1-p41.png",
  body: (S) => {
    const heat = getWardHeat();
    const attitude = getManorAttitudeLabel();

    const shimmer =
      heat >= 2
        ? `<p>The air ahead shimmers like heat above stone, though the corridor is cold.</p>`
        : `<p>A faint distortion hangs across the hallway, nearly invisible unless you look sideways.</p>`;

    const mira =
      attitude === "wary"
        ? `<p class="rw-intro-dialog">â€œThis ward punishes false vows,â€ Mira warns. â€œDonâ€™t promise anything.â€</p>`
        : `<p class="rw-intro-dialog">â€œOath-air,â€ Mira says. â€œIt listens for vows you donâ€™t realize youâ€™re making.â€</p>`;

    return `
      ${shimmer}
      ${mira}
      <p>You realize how many of your ordinary sentences are actually promises in disguise.</p>
    `;
  },
  choices: [
    {
      text: "Cross without making any statement at all. (Will DC 12)",
      to: "42",
      key: "p41_cross_silent",
      check: {
        label: "Restraint",
        stat: "will",
        dc: 12,
        successMsg: "You hold your tongue. The air lets you pass cleanly.",
        failMsg: "A word rises anywayâ€”half-formed. The ward catches the intention.",
        deltaWardHeatFail: +1,
        deltaAttitudeFail: -1,
      },
    },
    {
      text: "Speak one careful truth with no promise attached. (Presence DC 13)",
      to: "42",
      key: "p41_one_truth",
      check: {
        label: "Exact Speech",
        stat: "presence",
        dc: 13,
        successMsg: "The ward relaxes. Precision lands as respect.",
        failMsg: "Your phrasing tilts into vow. The air tightensâ€”recording.",
        deltaAttitudeSuccess: +2,
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Ask Mira for a safe sentence to say here. (Insight DC 12)",
      to: "42",
      key: "p41_safe_sentence",
      check: {
        label: "Prudence",
        stat: "insight",
        dc: 12,
        successMsg: "Mira gives you a single neutral phraseâ€”and the ward accepts it.",
        failMsg: "Mira refuses. â€œYou have to learn your own edges.â€",
        deltaAttitudeFail: -1,
      },
    },
  ],
},

"42": {
  title: "The Oath That Almost Happened",
  image: "b1-p42.png",
  body: (S) => {
    const f = S.flags || {};
    const heat = getWardHeat();

    const after =
      f.p41_cross_silent_success
        ? `<p>You pass cleanly. The air feels clearer on the other side.</p>`
        : f.p41_one_truth_success
        ? `<p>The shimmer disperses. You feelâ€¦ acknowledged.</p>`
        : (f.p41_cross_silent_fail || f.p41_one_truth_fail)
        ? `<p>The air clings briefly, like it took a small copy of your intent.</p>`
        : `<p>You pass, and only afterward realize how close you were to promising something aloud.</p>`;

    const heatLine =
      heat >= 2
        ? `<p class="rw-intro-dialog">â€œThat ward just put you on a shorter leash,â€ Mira mutters.</p>`
        : `<p class="rw-intro-dialog">â€œGood,â€ Mira says softly. â€œIt didnâ€™t hook you.â€</p>`;

    return `
      ${after}
      ${heatLine}
      <p>The corridor bends toward a door marked with a faint crescent carved into the stone.</p>
    `;
  },
  choices: [
    {
      text: "Follow Mira to the crescent-marked door.",
      to: "43",
      key: "p42_follow_crescent",
    },
    {
      text: "Ask what the crescent means. (Insight DC 12)",
      to: "43",
      key: "p42_ask_crescent",
      check: {
        label: "Symbol",
        stat: "insight",
        dc: 12,
        successMsg: "You sense itâ€™s not â€˜moonâ€™â€”itâ€™s â€˜cycle.â€™ A door that repeats.",
        failMsg: "The meaning slips. The manor keeps some symbols private until you earn them.",
        deltaAttitudeSuccess: +1,
      },
    },
  ],
},

"43": {
  title: "The Crescent Door",
  image: "b1-p43.png",
  body: (S) => {
    const heat = getWardHeat();
    const attitude = getManorAttitudeLabel();

    const door =
      heat >= 2
        ? `<p>The crescent mark seems to darken as you approach, like ink soaking into stone.</p>`
        : `<p>The crescent mark catches lantern light like polished bone.</p>`;

    const mood =
      attitude === "welcoming"
        ? `<p>The handle feels cool but not punishing.</p>`
        : attitude === "wary"
        ? `<p>The handle feels like consequence waiting to happen.</p>`
        : `<p>The handle feels neutralâ€”ready to become whatever you bring to it.</p>`;

    return `
      ${door}
      ${mood}
      <p class="rw-intro-dialog">â€œThis door repeats itself,â€ Mira says. â€œIt asks the same thing different ways.â€</p>
      <p class="rw-intro-dialog">â€œIf you answer inconsistentlyâ€¦ it notices.â€</p>
    `;
  },
  choices: [
    {
      text: "Answer the doorâ€™s question with consistency. (Will DC 13)",
      to: "44",
      key: "p43_consistent",
      check: {
        label: "Consistency",
        stat: "will",
        dc: 13,
        successMsg: "The latch softens. The door accepts a stable self.",
        failMsg: "Your intent wobbles. The crescent mark darkensâ€”recording instability.",
        deltaAttitudeFail: -1,
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Try to outsmart the repetition. (Insight DC 13)",
      to: "44",
      key: "p43_outsmart",
      check: {
        label: "Cleverness",
        stat: "insight",
        dc: 13,
        successMsg: "You spot the repeating pattern and step through on the â€˜quietâ€™ beat.",
        failMsg: "The door repeats faster. You lose the rhythmâ€”and it counts that as failure.",
        deltaWardHeatFail: +1,
        deltaAttitudeFail: -1,
      },
    },
    {
      text: "Ask Mira to anchor you before you touch it. (Presence DC 12)",
      to: "44",
      key: "p43_anchor_me",
      check: {
        label: "Trust Mira",
        stat: "presence",
        dc: 12,
        successMsg: "Mira steadies your focus with one sentence. The door responds better.",
        failMsg: "Mira tries, but your mind still scatters. The door catches the scatter.",
        deltaAttitudeSuccess: +1,
        deltaWardHeatFail: +1,
      },
    },
  ],
},

"44": {
  title: "A Hallway Youâ€™ve Already Walked",
  image: "b1-p44.png",
  body: (S) => {
    const f = S.flags || {};
    const heat = getWardHeat();

    const loop =
      (f.p43_consistent_success || f.p43_outsmart_success || f.p43_anchor_me_success)
        ? `<p>The door opensâ€”and you step into a corridor that feels oddly familiar.</p>`
        : `<p>The door opensâ€”and you step into a corridor that feels <em>exactly</em> familiar.</p>`;

    const sting =
      heat >= 2
        ? `<p>The lanterns are in the same positionsâ€¦ but the shadows are not.</p>`
        : `<p>The walls are the same stoneâ€¦ but the air tastes slightly different.</p>`;

    return `
      ${loop}
      ${sting}
      <p>You realize the manor just showed you a version of the path you already took.</p>
      <p class="rw-intro-dialog">â€œItâ€™s checking if youâ€™ve changed,â€ Mira whispers.</p>
    `;
  },
  choices: [
    {
      text: "Prove you remember: name one ward you passed correctly. (Insight DC 12)",
      to: "45",
      key: "p44_name_ward",
      check: {
        label: "Recall",
        stat: "insight",
        dc: 12,
        successMsg: "The corridor relaxes. Memory counts as competence here.",
        failMsg: "You hesitate too long. The manor marks uncertainty.",
        deltaAttitudeSuccess: +1,
        deltaWardHeatFail: +1,
      },
    },
    {
      text: "Donâ€™t perform. Walk with the same honesty as before. (Presence DC 12)",
      to: "45",
      key: "p44_no_perform",
      check: {
        label: "No Performance",
        stat: "presence",
        dc: 12,
        successMsg: "The corridor accepts the consistency. Performance would have been the trap.",
        failMsg: "Your posture shifts into defense. The manor reads it as concealment.",
        deltaAttitudeFail: -1,
        deltaWardHeatFail: +1,
      },
    },
    { text: "Ask Mira if this is a loop or a test.", to: "45", key: "p44_loop_or_test" },
  ],
},

"45": {
  title: "Filed Under: Repeatable",
  image: "b1-p45.png",
  body: (S) => {
    const heat = getWardHeat();
    const attitude = getManorAttitudeLabel();
    const f = S.flags || {};

    const pass =
      (f.p44_name_ward_success || f.p44_no_perform_success)
        ? `<p>The corridor loosens, as if it accepted your stability as real.</p>`
        : (f.p44_name_ward_fail || f.p44_no_perform_fail)
        ? `<p>The corridor remains tightâ€”like the manor added a note to your file.</p>`
        : `<p>The corridor holds neutral, watching.</p>`;

    const mood =
      attitude === "welcoming"
        ? `<p class="rw-intro-dialog">â€œIt likes you more when youâ€™re consistent,â€ Mira says, almost reluctantly.</p>`
        : attitude === "wary"
        ? `<p class="rw-intro-dialog">â€œItâ€™s still deciding,â€ Mira murmurs. â€œBut itâ€™s decided youâ€™reâ€¦ repeatable.â€</p>`
        : `<p class="rw-intro-dialog">â€œWatchful,â€ Mira says. â€œBut not shutting you out.â€</p>`;

    const heatLine =
      heat >= 2
        ? `<p>You feel it: the manor is now predicting your choices before you make them.</p>`
        : `<p>You feel it: the manor has started building expectations around your behavior.</p>`;

    return `
      ${pass}
      ${mood}
      ${heatLine}
      <p>A new door waits aheadâ€”unmarked, unadorned, almost politely plain.</p>
      <p class="rw-intro-dialog">â€œNext,â€ Mira says, â€œis where it asks for something back.â€</p>
    `;
  },
  choices: [
    { text: "Continue.", to: "46", key: "p45_continue" },
    { text: "Open Inventory.", to: "45", key: "p45_inventory_hint" },
  ],
},

"46": {
  title: "The Final Filing",
  body: `
    <p>The corridor opens into a circular chamber.</p>
    <p>No wards flare. No pressure rises.</p>
    <p>The manor is no longer testing.</p>
    <p>It is <em>deciding</em>.</p>
    <p class="rw-intro-dialog">â€œThis is where it finishes your file,â€ Mira says.</p>
  `,
  choices: [
    { text: "Stand still and let it decide.", to: "47", key: "p46_still" },
    { text: "Ask if the decision can change.", to: "47", key: "p46_ask" },
  ],
},

"47": {
  title: "What the Manor Saw",
  body: `
    <p>You feel moments replayâ€”not images, but <em>weight</em>.</p>
    <p>When you held.</p>
    <p>When you pushed.</p>
    <p>When you chose not to speak.</p>
    <p>The manor does not judge.</p>
    <p>It categorizes.</p>
  `,
  choices: [{ text: "Continue.", to: "48" }],
},

"48": {
  title: "The Name It Uses",
  body: (S) => {
    const archetype = resolveBook1Class();
    const affinity = resolveBook1Affinity();

    // Persist
    window.rwPlayerClass = archetype;
    window.rwMagicAffinity = affinity;

    if (typeof window.syncCharacterProfile === "function") {
      window.syncCharacterProfile({
        archetype,
        affinity,
      });
    }

    return `
      <p>The manor settles on a designation.</p>
      <p class="rw-intro-dialog">â€œNot a title,â€ Mira says. â€œA shorthand.â€</p>
      <p class="rw-highlight">
        ${archetype.replace("_", " ").toUpperCase()}
      </p>
      <p>
        The magic that answers you first:
        <strong>${affinity.toUpperCase()}</strong>
      </p>
    `;
  },
  choices: [{ text: "Accept.", to: "49" }],
},

"49": {
  title: "What You Look Like to the Manor",
  body: (S) => {
    const archetype = window.rwPlayerClass;

    const avatarMap = {
      ward_witch: "avatar-ward.png",
      wild_witch: "avatar-wild.png",
      seer_witch: "avatar-seer.png",
      anchor_witch: "avatar-anchor.png",
      ritualist_witch: "avatar-ritualist.png",
      shadow_witch: "avatar-shadow.png",
    };

    const avatar = avatarMap[archetype];

    if (typeof window.unlockAvatar === "function") {
      window.unlockAvatar(avatar);
    }

    return `
      <p>The mirror-lintels no longer distort.</p>
      <p>They reflect you clearly.</p>
      <p class="rw-intro-dialog">â€œThatâ€™s how it sees you,â€ Mira says.</p>
      <p class="rw-note">New avatar unlocked.</p>
    `;
  },
  choices: [{ text: "Continue.", to: "50" }],
},

"50": {
  title: "Initiation Complete",
  body: `
    <p>The manor does not say goodbye.</p>
    <p>It simply stops watching so closely.</p>
    <p class="rw-intro-dialog">
      â€œYouâ€™re not a guest anymore,â€ Mira says.
      â€œBut youâ€™re not finished.â€
    </p>
    <p>Book I complete.</p>
    <p><strong>Book II unlocked.</strong></p>
  `,
  choices: [
    { text: "Begin Book II.", to: "book-2-start" },
    { text: "Open Character Sheet.", to: "character" },
  ],
},

      };

      function renderBookInventory() {
  invGrid.innerHTML = "";

  const inv = window.rwInventory || [];

  if (!inv.length) {
    invGrid.innerHTML = `<p class="small text-muted">Your pack is empty.</p>`;
    return;
  }

  inv.forEach(item => {
    const slot = document.createElement("div");
    slot.className = "rw-inventory-slot";

    const meta = getItemMetadata(item);
    if (!meta) return;

    const img = document.createElement("img");
    img.src = meta.icon || "";
    img.alt = meta.title;

    img.addEventListener("click", () => {
      selectedItem = item;
      itemModalTitle.textContent = meta.title;
      itemModalDesc.textContent = meta.description;
      itemModal.show();
    });

    slot.appendChild(img);
    invGrid.appendChild(slot);
  });
}

invToggle.addEventListener("click", () => {
  renderBookInventory();
  invPanel.classList.remove("d-none");
});

invClose.addEventListener("click", () => {
  invPanel.classList.add("d-none");
});

      // ----------------------------
      // Helpers
      // ----------------------------
      function showSystemMessage(msg) {
        if (!elSys) return;
        if (!msg) {
          elSys.classList.add("d-none");
          elSys.textContent = "";
          return;
        }
        elSys.textContent = msg;
        elSys.classList.remove("d-none");
      }

      function setPageImage(src) {
        if (!elImage) return;
        if (!src) {
          elImage.style.display = "none";
          elImage.src = "";
          return;
        }
        elImage.style.display = "block";
        elImage.src = src;
      }

      // ----------------------------
// REQUIRED GLUE: metadata + choice handling + deltas + echo
// ----------------------------

// If app.js already provides this, we use it.
// Otherwise: fallback metadata so the book inventory never breaks.
function getItemMetadata(item) {
  if (!item) return null;

  // Prefer a global helper if you have one in app.js
  if (typeof window.getItemMetadata === "function") {
    return window.getItemMetadata(item);
  }

  // Common shapes
  const title = item.title || item.name || item.id || "Item";
  const icon = item.icon || item.image || item.img || "";
  const description =
    item.description ||
    item.desc ||
    (item.quest ? "A quest item. It feels important." : "No description.");

  return { title, icon, description };
}

function applyChoiceDeltas(choice) {
  // Support inline deltas on choices
  if (Number.isFinite(Number(choice?.deltaAttitude))) bumpManorAttitude(Number(choice.deltaAttitude));
  if (Number.isFinite(Number(choice?.deltaWardHeat))) bumpWardHeat(Number(choice.deltaWardHeat));
}

// Make sure the â€œechoâ€ has somewhere to show up.
// We inject it at the top of the body each render.
function injectChoiceEchoIntoBody(pageId) {
  const echoHtml = buildChoiceEchoHtml(BOOK_STATE, pageId);
  if (!echoHtml) return;

  // prepend echo block
  elBody.innerHTML =
    `<div class="rw-choice-echo small text-muted mb-3"><strong>â€”</strong> ${echoHtml}</div>` +
    elBody.innerHTML;
}

function handleChoice(choice) {
  if (!choice) return;

  // Remember last choice key (for echo + flags)
  BOOK_STATE.lastChoiceKey = choice.key || null;

  // Apply check (if any)
  if (choice.check) {
    const r = rollCheck(choice.check);

    // Store success/fail flags for *this* choice key
    if (choice.key) {
      BOOK_STATE.flags = BOOK_STATE.flags || {};
      BOOK_STATE.flags[`${choice.key}_${r.success ? "success" : "fail"}`] = true;
    }
  }

  // Apply deltas on the choice itself (even if there was a check)
  applyChoiceDeltas(choice);

  // Go to next page
  const next = String(choice.to || "");
  if (next && BOOK_PAGES[next]) {
    renderPage(next);
  } else {
    // If a page target is missing, donâ€™t crashâ€”show a system message.
    showSystemMessage(`That path isnâ€™t written yet (${next || "no target"}).`);
  }
}

// --- OPTIONAL: make â€œUseâ€ button do something for book inventory items ---
if (itemUseBtn) {
  itemUseBtn.addEventListener("click", async () => {
    if (!selectedItem) return;

    // If app.js has a unified "use item" hook, prefer it
    if (typeof window.useSelectedItem === "function") {
      await window.useSelectedItem(selectedItem);
      if (itemModal) itemModal.hide();
      renderBookInventory();
      return;
    }

    // Minimal: journal opens journal modal if you built one in app.js
    if (selectedItem.id === "ravenwood_journal") {
      if (typeof window.rwOpenJournal === "function") window.rwOpenJournal();
      showSystemMessage("The journalâ€™s ink stirsâ€”as if listening.");
      if (itemModal) itemModal.hide();
      return;
    }

    showSystemMessage("That item canâ€™t be used here (yet).");
    if (itemModal) itemModal.hide();
  });
}

      
// ----------------------------
// Choice Echo (reactive narration)
// Shows immediate, matching response to the player's *last* choice / roll.
// ----------------------------
function buildChoiceEchoHtml(state, pageId) {
  if (!state || !state.lastChoiceKey) return "";
  if (String(pageId) === "1") return "";

  const k = String(state.lastChoiceKey || "");
  const f = state.flags || {};

  // Prefer roll-flavored echoes if present
  const success = !!f[`${k}_success`];
  const fail = !!f[`${k}_fail`];

  const E = {
    // Page 1
    p1_listen: "You slow and listen. The fog answers with silence heavy enough to feel like a warning.",
    p1_belong: "You walk like you belong. The road accepts the lieâ€”just long enough to test you.",
    p1_breathe: "You stop and breathe. The threshold stone warms as if acknowledging your restraint.",

    // Page 2
    p2_step_in: "You step inside without bargaining. Miraâ€™s eyes softenâ€”only slightly.",
    p2_ask_who: "You ask first. Mira gives her name like a key: offered, but not handed over.",
    p2_talisman: "You touch the talisman. Miraâ€™s gaze snaps to it, and the air tightens around the chain.",

    // Page 3
    p3_follow: "You follow. The manor notes your compliance the way a lock notes the right turn.",
    p3_ask_talisman: "You ask what the talisman is for. Mira doesnâ€™t answer fullyâ€”only enough to keep you alive.",

    // Page 4
    p4_follow: "You keep moving forward. Behind you, the doors stay quietâ€”too quiet.",
    p4_test_door: "You test the door. It doesnâ€™t fight you. It simply refuses, like a rule older than iron.",

    // Page 5
    p5_forward: "You keep your eyes forward. The portraits track you anyway, measuring your nerve.",
    p5_stare_back: "You stare back. One portraitâ€™s eyes sharpen, and you feel brieflyâ€¦ recognized.",
    p5_ask_portraits: "You ask who they were. Miraâ€™s answer is careful: â€œNot all of them stayed human.â€",

    // Page 6
    p6_search_seam: success
      ? "You find a hidden seam in the wardworkâ€”an intentional breathing stitch. The manor growsâ€¦ curious."
      : "You search for a seam and find only smooth stone. Your fingertips go numb, as if the ward denies inquiry.",
    p6_ask_lie: "You ask what counts as a lie here. Miraâ€™s mouth twists: â€œWhatever the house decides.â€",
    p6_silent: "You stay silent. The manor rewards silence the way predators reward stillness.",

    // Page 7
    p7_cross_honest: "You cross honestly. The ward does not welcome youâ€”but it does *record* you.",
    p7_step_between: "You try to step between the lines. The ward flaresâ€”annoyed you thought it wouldnâ€™t notice.",
    p7_greet_house: "You greet the manor. The lanterns answer with a faint, synchronized pulse.",

    // Page 8
    p8_breath_control: "You control your breathing. The descending air feels less like drowning and more like initiation.",
    // was: p8_count_steps
p8_match_pulse: "You count the pulses. The number refuses to stay consistentâ€”like the stairs are rewriting themselves.",

    p8_dont_trust: "You admit you donâ€™t trust this. Mira doesnâ€™t argue. She only says, â€œGood. Keep that.â€",

    // Page 9
    p9_touch_circle: "You touch the circle. Cold bites your palmâ€”and something beneath the stone shifts its attention.",
    p9_ask_candles: "You ask about the candles. Mira: â€œThey are questions. The house lights them when it likes your answers.â€",
    p9_hold_back: "You hold back. The chamber remains patient, as if it prefers cautious guests.",

    // Page 10
    p10_speak_name: "You speak your name aloud. The room *takes* itâ€”quietly, permanently.",
    p10_refuse_name: "You refuse your name. The manor doesnâ€™t punish you. It simply marks you asâ€¦ complicated.",
    p10_offer_truth: "You offer a true thing instead. The wardwork relaxes a fraction, like it recognizes sincerity.",

    // Page 11 (archetype pick)
    p11_shadow: "Shadow answers youâ€”cold, elegant, and hungry for quiet power.",
    p11_rune: "Runes answer youâ€”patient, exact, and more dangerous than they look.",
    p11_guardian: "Gates answer youâ€”duty, weight, and a promise you didnâ€™t realize you were making.",
    p11_moon: "Moon answers youâ€”lunar, ancient, and intensely personal.",

    // Page 12
    p12_accept_mark: "You accept the mark. The talisman warmsâ€”approval without affection.",
    p12_refuse_mark: "You resist the mark. The ward doesnâ€™t force youâ€”yetâ€”but the manor becomes watchful in a new way.",
    p12_question_mira: "You press Mira for more. She gives you a look that says: *later, if you survive.*",

    // Page 13
    p13_search_niche: success
      ? "You discover a niche in the stoneâ€”fresh enough to be recent. Something has been moved here."
      : "You search the walls and find nothing, but the search itself stirs the wardheat like a brushed hive.",
    p13_follow_hum: "You follow the hum. It leads you toward a place that feels *forbidden*, not hidden.",
    p13_wait: "You wait. The manor *likes* patienceâ€”then tests it.",

    // Page 14
    p14_open_door: success
      ? "You open the door without breaking the ward. The manor notes your finesse."
      : "The ward snaps. The latch burns cold, and the corridor seems to recoil from you.",
    p14_force: "You force it. The manor yields, but your name becomes sharper in its memory.",
    p14_back: "You step back. The house exhalesâ€”like you avoided a mistake it expected you to make.",

    // Page 15
    p15_take_journal: "You take the journal. The paper feels warmâ€”as if it has already been waiting in your hands.",
    p15_leave_journal: "You leave the journal. Behind you, the desk drawer shuts by itselfâ€”quietly offended.",
    p15_read_margins: "You read the margins. The ink shifts, and you realize someone wrote to *you*, not the page.",

    // Page 16
    p16_accept_help: "You accept Miraâ€™s help. The manorâ€™s attention loosensâ€”barelyâ€”like it respects cooperation.",
    p16_refuse_help: "You refuse help. Mira doesnâ€™t shame you. She only watches, measuring how long pride lasts under wards.",

    // Page 17
    p17_drink: "You drink. Warmth spreads like a vow being signed inside your ribs.",
    p17_hesitate: "You hesitate. The manor does not rush you. It simply waitsâ€”confident you will choose eventually.",

    // Page 18
    p18_steady: "You steady yourself. The corridor feels less hostileâ€”moreâ€¦ evaluative.",
    p18_press: "You press forward anyway. Your courage earns you no comfortâ€”only more scrutiny.",

    // Page 19
    p19_still: "You go still. The ward passes over you like moonlight over stone.",
    p19_search: success
      ? "You find a hidden sigil-thread. It is *new*. Someone has been meddling with old protections."
      : "You search and the ward bites backâ€”your vision swims with symbols that refuse interpretation.",

    // Page 20
    p20_found: "You admit you found something. Miraâ€™s expression goes tight: â€œDonâ€™t show it to the wrong part of the house.â€",
    p20_return: "You return it where it was. The manorâ€™s mood improvesâ€”welcoming, in its own severe way.",

    // Page 21
    p21_remain: "You remain in the circle. The air grows dense with expectationâ€”as if the house is about to speak.",
    p21_retreat: "You retreat. The house doesnâ€™t chase you. It simply remembers you chose distance.",

    // Page 22
    p22_hold_ground: "You hold your ground. The wardheat risesâ€”like the manor respects defiance but refuses to *reward* it.",
    p22_step_back: "You step back. Mira nods once: â€œGood. Live first. Learn second.â€",

    // Page 23
    p23_dodge: success
      ? "You dodge cleanly. The wardâ€™s strike misses by inches, and the chamber resetsâ€”as if impressed."
      : "You try to dodge and stumble. The wardâ€™s pressure clips youâ€”painful, but not fatal.",
    p23_freeze: "You freeze. For a heartbeat nothing happensâ€”then the ward answers, brutal in its patience.",

    // Page 24
    p24_scramble: "You scramble. The manorâ€™s lanterns gutter, as if laughing without sound.",
    p24_stand: "You force yourself upright. The house goes very still, and something ancient listens.",

    // Page 25
    p25_hold: "You hold on. The fear doesnâ€™t vanishâ€”but it becomes fuel.",

    // Page 26
    p26_awaken: "You stop fighting whatâ€™s inside you. The manor holds its breath, waiting to see what you are.",

    // Page 27
    p27_aftermath: "In the aftermath, the silence isnâ€™t empty. Itâ€™s the manor deciding what youâ€™ve earned.",

    // Page 28
    p28_next: "You choose what comes next. The house shiftsâ€”subtleâ€”rearranging doors like possibilities.",
    p28_silent: "You stay silent. The manor seems almost pleased, as if silence is one of its native tongues.",

    // Page 29
    p29_close: "You close the journal. The ink settles, obedient, like it knows it will be read again.",

    // Page 30
    p30_end: "You leave Book I changed. The manor doesnâ€™t say goodbye. It simplyâ€¦ keeps a door ready.",
  };

  const line = E[k];
  if (!line) return "";

  // Also hint at ward heat / attitude shifts (without exposing numbers)
  const label = getManorAttitudeLabel();
  const heat = getWardHeat();

  const heatLabel = heat >= 3 ? "high" : heat === 2 ? "rising" : heat === 1 ? "low" : "calm";

  return `
    <div class="rw-choice-echo alert alert-dark border border-secondary mb-3">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <strong>Echo:</strong>
        <span class="small text-muted">Manor: <span class="text-uppercase">${label}</span> Â· Wards: ${heatLabel}</span>
      </div>
      <div class="mt-2">${line}</div>
    </div>
  `;
}

function renderChoices(page) {
  if (!elChoices) return;
  elChoices.innerHTML = "";

  const choices = Array.isArray(page.choices) ? page.choices : [];
  choices.forEach((c) => {
    const btn = document.createElement("button");
    btn.className = "btn btn-outline-light";
    btn.type = "button";
    btn.textContent = c.text || "Continue";

    btn.addEventListener("click", async () => {
      // choice bookkeeping
      if (c.key) {
        BOOK_STATE.flags[c.key] = true;
        BOOK_STATE.lastChoiceKey = c.key;
      }

      // optional roll
      let roll = null;
      if (c.check) {
        roll = rollCheck(c.check);

        // store success/fail flavor flags for page reactivity
        if (c.key) {
          BOOK_STATE.flags[`${c.key}_${roll.success ? "success" : "fail"}`] = true;
        } else if (c.check?.flagKey) {
          BOOK_STATE.flags[`${c.check.flagKey}_${roll.success ? "success" : "fail"}`] = true;
        }
      }

      // optional direct attitude change (no roll)
      if (!c.check && Number.isFinite(Number(c.deltaAttitude))) {
        bumpManorAttitude(Number(c.deltaAttitude));
      }
      if (!c.check && Number.isFinite(Number(c.deltaWardHeat))) {
        bumpWardHeat(Number(c.deltaWardHeat));
      }

      // Handle END
      if (String(c.to).toUpperCase() === "END") {
        window.location.href = "ravenwood.html";
        return;
      }

      // resolve destination (supports object form)
      let dest = c.to;
      if (dest && typeof dest === "object") {
        const s = !!roll?.success;
        dest = s ? (dest.success || dest.ok) : (dest.fail || dest.no);
      } else if (roll && (c.toSuccess || c.toFail)) {
        dest = roll.success ? c.toSuccess : c.toFail;
      }

      await goToPage(String(dest || "1"));
    });

    elChoices.appendChild(btn);
  });
}

      function renderPage(pageId) {
  const page = BOOK_PAGES[pageId];
  if (!page) return;

  BOOK_STATE.currentPageId = pageId;

  // Header meta (with Manor Attitude)
  if (elMeta) {
    const n = String(pageId).split("_")[0];
    const label = getManorAttitudeLabel();
    const badgeClass =
      label === "welcoming" ? "bg-success" :
      label === "wary" ? "bg-danger" :
      "bg-warning text-dark";

    elMeta.innerHTML = `Page ${n} Â· Manor: <span class="badge ${badgeClass} text-uppercase">${label}</span>`;
  }

  if (elTitle) elTitle.textContent = page.title || "";

  const bodyHtml = (typeof page.body === "function") ? page.body(BOOK_STATE) : (page.body || "");
  const echoHtml = buildChoiceEchoHtml(BOOK_STATE, pageId);
  if (elBody) elBody.innerHTML = echoHtml + bodyHtml;

  injectChoiceEchoIntoBody(pageId);

  setPageImage(page.image || "");
  showSystemMessage(page.systemMessage || "");

  renderChoices(page);
  applyAffinityBranches();
}


function applyDeltas(choice) {
  if (Number.isFinite(Number(choice.deltaAttitude))) bumpManorAttitude(Number(choice.deltaAttitude));
  if (Number.isFinite(Number(choice.deltaWardHeat))) bumpWardHeat(Number(choice.deltaWardHeat));
}

function handleChoice(choice) {
  if (!choice) return;

  // record choice
  BOOK_STATE.lastChoiceKey = choice.key || null;
  BOOK_STATE.flags = BOOK_STATE.flags || {};
  if (choice.key) BOOK_STATE.flags[choice.key] = true;

  // rolls (optional)
  if (choice.check) {
    const r = rollCheck(choice.check);
    const key = choice.key || "choice";
    BOOK_STATE.flags[`${key}_${r.success ? "success" : "fail"}`] = true;
  }

  // simple deltas
  applyDeltas(choice);

  // go to next page
  const next = String(choice.to || "");
  if (next && BOOK_PAGES[next]) renderPage(next);
}

      async function goToPage(pageId) {
  // If user lands on a class page, persist archetype
  if (pageId === "11_shadow") await setArchetype("shadow-witch");
  if (pageId === "11_rune") await setArchetype("scholar-of-runes");
  if (pageId === "11_guardian") await setArchetype("guardian-of-gates");
  if (pageId === "11_moon") await setArchetype("seer-of-moons");

  await saveBookProgress(pageId);   // âœ… ADD THIS

  renderPage(pageId);
}

function handleChoice(choice) {
  BOOK_STATE.lastChoiceKey = choice.key;

  // Simple flag
  if (choice.key) {
    BOOK_STATE.flags[choice.key] = true;
  }

  // Skill check
  if (choice.check) {
    const result = rollCheck(choice.check);

    BOOK_STATE.flags[`${choice.key}_${result.success ? "success" : "fail"}`] = true;
  }

  // Attitude delta without check
  if (Number.isFinite(choice.deltaAttitude)) {
    bumpManorAttitude(choice.deltaAttitude);
  }

  // Move to next page
  if (choice.to) {
    renderPage(choice.to);
  }
}

async function setArchetype(archetype) {
  const email = localStorage.getItem("ravenwoodEmail");
  const sb = window.supabaseClient || null;
  if (!email || !sb) return;

  try {
    const { error } = await sb
      .from("data")
      .update({ archetype })
      .eq("email", email);

    if (error) throw error;
  } catch (e) {
    console.warn("setArchetype failed:", e);
  }
}

function applyAffinityBranches() {
  const affinity =
    BOOK_STATE.flags?.class_shadow ? "wind" :
    BOOK_STATE.flags?.class_rune ? "water" :
    BOOK_STATE.flags?.class_guardian ? "stone" :
    BOOK_STATE.flags?.class_moon ? "flame" :
    "flame";

  document.querySelectorAll(".rw-awaken-branch").forEach((el) => {
    const isMatch = el.dataset.affinity === affinity;
    el.classList.toggle("d-none", !isMatch);
  });
}


      // ----------------------------
      // Inventory (Book view)
      // Uses window.rwInventory + helpers from app.js
      // ----------------------------
      function getCurrentInventory() {
        // Prefer Supabase-loaded memory if your app sets it; fallback to local loadInventory()
        if (Array.isArray(window.rwInventory)) return window.rwInventory;
        if (typeof window.loadInventory === "function") return window.loadInventory();
        return [];
      }

      async function setCurrentInventory(items) {
        window.rwInventory = Array.isArray(items) ? items : [];
        if (typeof window.syncInventoryToSupabase === "function") {
          await window.syncInventoryToSupabase(window.rwInventory);
        }
      }

      async function saveBookProgress(pageId) {
  const pid = String(pageId || "1");

  // local fallback (so refresh works even if offline)
  try { localStorage.setItem("rwBook1Progress", pid); } catch {}

  const email = window.rwEmail || localStorage.getItem("ravenwoodEmail");
  const sb = window.supabaseClient || null;
  if (!email || !sb) return;

  try {
    // Preferred: store directly in data.book1_progress (text)
    let { error } = await sb
      .from("data")
      .update({ book1_progress: pid })
      .eq("email", email);

    if (error) {
      // If the row doesn't exist yet, try upsert (requires unique constraint on email)
      const up = await sb
        .from("data")
        .upsert({ email, book1_progress: pid }, { onConflict: "email" });

      if (up.error) throw up.error;
    }
  } catch (e) {
    console.warn("saveBookProgress failed:", e);
  }
}


async function loadBookProgress() {
  const email = window.rwEmail || localStorage.getItem("ravenwoodEmail");
  const sb = window.supabaseClient || null;

  // Supabase first
  if (email && sb) {
    try {
      const { data, error } = await sb
        .from("data")
        .select("book1_progress")
        .eq("email", email)
        .maybeSingle();

      if (!error && data && data.book1_progress) {
        const pid = String(data.book1_progress);
        try { localStorage.setItem("rwBook1Progress", pid); } catch {}
        return pid;
      }
    } catch (e) {
      console.warn("loadBookProgress failed:", e);
    }
  }

  // local fallback
  try {
    const raw = localStorage.getItem("rwBook1Progress");
    return raw ? String(raw) : null;
  } catch {
    return null;
  }
}


      function openInventory() {
        if (!invPanel) return;
        invPanel.classList.remove("d-none");
        renderInventoryGrid();
      }

      function closeInventory() {
        if (!invPanel) return;
        invPanel.classList.add("d-none");
      }

      function renderInventoryGrid() {
        if (!invGrid) return;
        const inv = getCurrentInventory();

        invGrid.innerHTML = "";

        if (!inv.length) {
          invGrid.innerHTML = `<div class="small text-muted p-2">Your pack is empty.</div>`;
          return;
        }

        inv.forEach((item) => {
          const meta = (typeof window.getItemMetadata === "function")
            ? window.getItemMetadata(item)
            : { title: item?.name || item?.id || "Item", description: "" };

          const cell = document.createElement("button");
          cell.type = "button";
          cell.className = "rw-inventory-slot btn btn-sm btn-outline-light";
          cell.style.display = "flex";
          cell.style.flexDirection = "column";
          cell.style.alignItems = "center";
          cell.style.justifyContent = "center";
          cell.style.gap = "0.25rem";

          // icon (optional)
          const iconSrc = meta.icon || item.icon || "";
          if (iconSrc) {
            const img = document.createElement("img");
            img.src = iconSrc;
            img.alt = meta.title;
            img.style.width = "42px";
            img.style.height = "42px";
            img.style.objectFit = "contain";
            img.onerror = () => img.remove();
            cell.appendChild(img);
          }

          const label = document.createElement("div");
          label.className = "small";
          label.textContent = meta.title;
          cell.appendChild(label);

          cell.addEventListener("click", () => {
            selectedItem = item;
            if (itemModalTitle) itemModalTitle.textContent = meta.title || "Item";
            if (itemModalDesc) itemModalDesc.textContent = meta.description || "";
            if (itemModal) itemModal.show();
          });

          invGrid.appendChild(cell);
        });
      }

      async function useSelectedItem() {
  if (!selectedItem) return;

  // Health potion
  if (selectedItem.id === "health_potion") {
    if (typeof window.rwAdjustHP === "function") {
      await window.rwAdjustHP(+20);
    }

    // remove ONE from inventory
    if (typeof window.rwRemoveOneFromInventory === "function") {
      await window.rwRemoveOneFromInventory(selectedItem.id);
    } else {
      

  // Ravenwood Journal (quest item)
  if (selectedItem.id === "ravenwood_journal") {
    showSystemMessage("You open the journal. The ink stirsâ€”like it was waiting for your attention.");

    // If the main journal modal exists on this page, open it
    try {
      const modalEl = document.getElementById("rwJournalModal");
      if (modalEl && window.bootstrap && bootstrap.Modal) {
        const jm = bootstrap.Modal.getOrCreateInstance(modalEl);
        if (typeof window.renderJournal === "function") window.renderJournal();
        jm.show();
      }
    } catch {}

    if (itemModal) itemModal.hide();
    return;
  }

  showSystemMessage("You arenâ€™t sure how to use that hereâ€¦ yet.");
  if (itemModal) itemModal.hide();
}

          // remove 1 potion from inventory
          
          const inv = getCurrentInventory();
const idx = inv.indexOf(selectedItem);
if (idx >= 0) inv.splice(idx, 1);
await setCurrentInventory(inv);

          await setCurrentInventory(next);

          showSystemMessage("Warmth spreads through your chest. Your breath steadies.");
          renderInventoryGrid();
        } else {
          showSystemMessage("You arenâ€™t sure how to use that hereâ€¦ yet.");
        }

        if (itemModal) itemModal.hide();
      }

      // Inventory buttons
      if (invToggle) invToggle.addEventListener("click", openInventory);
      if (invClose) invClose.addEventListener("click", closeInventory);
      if (itemUseBtn) itemUseBtn.addEventListener("click", useSelectedItem);

      // ----------------------------
      // Boot
      // ----------------------------
    document.addEventListener("DOMContentLoaded", async () => {
      const email = localStorage.getItem("ravenwoodEmail");
      if (!email) {
        window.location.href = "login.html";
        return;
      }

      // Load last saved page from Supabase (book1_progress)
      const saved = (typeof loadBookProgress === "function") ? await loadBookProgress() : null;
      if (saved) BOOK_STATE.currentPageId = String(saved);

      // Render the current page (defaults to "1")
      if (typeof goToPage === "function") {
        await goToPage(BOOK_STATE.currentPageId || "1");
      } else if (typeof renderPage === "function") {
        renderPage(BOOK_STATE.currentPageId || "1");
      }
    });


    })();
</script>

</body>
</html>